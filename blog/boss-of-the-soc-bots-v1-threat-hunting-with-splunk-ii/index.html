<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Boss Of The SOC (BOTS) v1 - Threat Hunting with Splunk (II) | Infomation Security - Blog</title><meta name="description" content="Description  The lab is provided by INE - Effectively Using Splunk (S1).  Another very good &amp; free lab: here.
    "><meta http-equiv="cache-control" content="max-age=29030400"><meta http-equiv="pragma" content="public"><meta name="keywords" content=""><meta name="author" content="Jay Nguyen"><meta http-equiv="Content-Language" content="en"><meta property="og:locale" content="en"><meta property="og:site_name" content="Infomation Security"><meta property="og:type" content="WebSite"><meta property="og:url" content="https://jayngng.github.io/blog/boss-of-the-soc-bots-v1-threat-hunting-with-splunk-ii/"><meta property="og:description" content="
    Blog"><meta property="og:title" content="Boss Of The SOC (BOTS) v1 - Threat Hunting with Splunk (II)
  "><link rel="canonical" href="https://jayngng.github.io/blog/boss-of-the-soc-bots-v1-threat-hunting-with-splunk-ii/"><link type="application/atom+xml" rel="alternate" title="Infomation Security" href="https://jayngng.github.io/feed.xml"><link rel="icon" type="image/png" sizes="32x32" href="https://jayngng.github.io/assets/images/favicon/favicon-32x32.png"><link href="https://fonts.googleapis.com/css?family=Special+Elite" rel="stylesheet"><script defer="defer" src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script><link rel="stylesheet" href="https://jayngng.github.io/assets/css/bootstrap.css"><link rel="stylesheet" href="https://jayngng.github.io/assets/css/jektify.css"><link rel="stylesheet" href="https://jayngng.github.io/assets/css/whiteglass.css"></head><body class="body underline_links" id="top"><div class="container layout_default"><div class="row"><div class="col-lg-3 px-0 mt-0 sidebar"><div class="py-3 sticky-top flex-grow-1"><div class="pt-3 sidebar__wrapper"><div class="nav flex-lg-column mx-3 mx-lg-0"><div class="d-none d-sm-block sidebar__avatar_flip"><div class="sidebar__avatar_flip-card"><a class="sidebar__avatar_flip-front sidebar__avatar_flip-face" href="https://jayngng.github.io/"><img class="p-1 img-fluid mx-auto d-block animation__pulse sidebar_avatar_circle sidebar_avatar_background sidebar_avatar_border image_avatar" src="/assets/images/avatar/author.jpg" alt="Avatar"> </a><a class="sidebar__avatar_flip-back sidebar__avatar_flip-face" href="https://jayngng.github.io/"><img class="p-1 img-fluid mx-auto d-block animation__pulse sidebar_avatar_circle sidebar_avatar_background sidebar_avatar_border image_avatar" src="/assets/images/avatar/athor_m.png" alt="Avatar"></a></div></div><h1 class="p-2 text-center d-md-flex align-items-center mx-auto animation__sidebar-title sidebar__title"><a href="https://jayngng.github.io/" class="nav-link" style="font-size: 2.3rem">whoami</a></h1><div class="p-2 mx-3 d-md-flex flex-md-column align-items-md-start align-items-center align-items-lg-start flex-lg-column mx-auto mr-lg-3 ml-lg-3 sidebar__menu animation__sidebar-menu"><div class="my-1 d-none d-md-block mr-3 sidebar__menu-title">Menu: Blog</div><li class="mr-3 mr-lg-0 float-left float-lg-none sidebar__menu-item"><i class="mr-1 fas fa-edit"></i> <a class="sidebar__menu-link" href="https://jayngng.github.io/blog/">Blog</a></li><li class="mr-3 mr-lg-0 float-left float-lg-none sidebar__menu-item"><i class="mr-1 fas fa-tags"></i> <a class="sidebar__menu-link" href="https://jayngng.github.io/blog/tags/">Tags</a></li><li class="mr-3 mr-lg-0 float-left float-lg-none sidebar__menu-item"><i class="mr-1 fas fa-search"></i> <a class="sidebar__menu-link" href="https://jayngng.github.io/blog/search/">Search</a></li></div></div></div></div></div><div class="col-lg-9 p-0 py-4 content" id="main"><div class="px-3 mt-lg-0 layout_post animation__content" itemscope itemtype="http://schema.org/BlogPosting"><div class="p-0 p-lg-3 mb-4 layout_post__header"><h1 class="font-weight-bold layout_post__title">Boss Of The SOC (BOTS) v1 - Threat Hunting with Splunk (II)</h1><div class="layout_post__date"><time class="layout_post__time"><i class="far fa-calendar-alt"></i> August 25, 2023</time></div><div class="layout_post__tags"><i class="fa fa-tags"></i>&nbsp;Tags:&nbsp; | <a class="layout_post__tags-link" href="https://jayngng.github.io/blog/tags//siem">siem</a> | <a class="layout_post__tags-link" href="https://jayngng.github.io/blog/tags//traffic_analysis">traffic_analysis</a> | <a class="layout_post__tags-link" href="https://jayngng.github.io/blog/tags//soc">soc</a> | <a class="layout_post__tags-link" href="https://jayngng.github.io/blog/tags//blue">blue</a> |</div><div class="layout_post__reading_time"><i class="far fa-clock"></i> Read this in "about 4 minutes".</div></div><div class="p-0 p-lg-3 mb-4 layout_post__content"><div class="d-block"><div class="py-3 row"><div class="offset-6 col-6 offset-sm-9 col-sm-3 offset-lg-10 col-lg-2"></div></div><h2 id="description"><strong>Description</strong></h2><ul><li>The lab is provided by INE - Effectively Using Splunk (S1).</li><li>Another very good &amp; free lab: <a href="https://samsclass.info/50/proj/botsv1.htm">here</a>.</li></ul><p>Continuing of <a href="https://jayngng.github.io/blog/boss-of-the-soc-bots-v1-events-analysis-with-splunk-i/">Boss Of The SOC (BOTS) v1 - Threat Hunting with Splunk (I)</a> …</p><p><br></p><h2 id="step-4---exploitation-activities"><strong>Step 4 - Exploitation Activities</strong></h2><p>In this phase, we’ll employ <code class="language-plaintext highlighter-rouge">Splunk</code> to uncover any exploitation activity on the network. Let’s us focus on <code class="language-plaintext highlighter-rouge">stream:http</code> sourcetype. The query is:</p><ul><li><code class="language-plaintext highlighter-rouge">index=botsv1 sourcetype="stream:http"</code></li></ul><p>Considering the following image:</p><div class="row imager__plugin"><img class="img-fluid mx-auto d-block" src="/assets/images/posts/botsv1/19.png" title="botsv1/19.png" alt="botsv1/19.png"></div><p>Looking at <code class="language-plaintext highlighter-rouge">http_method</code> section in the <code class="language-plaintext highlighter-rouge">INTERESTING FIELDS</code> column, it’s obvious that <code class="language-plaintext highlighter-rouge">POST</code> requests account for a large portion of <code class="language-plaintext highlighter-rouge">HTTP</code> requests.</p><p>We are also interested in the requests being sent to <code class="language-plaintext highlighter-rouge">192.168.250.70</code>, which is our organization website. The search we use is as the following.</p><ul><li><code class="language-plaintext highlighter-rouge">index="botsv1" sourcetype="stream:http" http_method="POST" dest="192.168.250.70" NOT "Acunetix"</code></li></ul><p><strong>Note:</strong> <code class="language-plaintext highlighter-rouge">NOT "Acunetix"</code> is specified to exclude <code class="language-plaintext highlighter-rouge">Acunetix</code> scanner requests.</p><p>Applying the search, the result is much cleaner. Let’s look at the <code class="language-plaintext highlighter-rouge">http_user_agent</code> field.</p><div class="row imager__plugin"><img class="img-fluid mx-auto d-block" src="/assets/images/posts/botsv1/20.png" title="botsv1/20.png" alt="botsv1/20.png"></div><p>We discovered that the agent <code class="language-plaintext highlighter-rouge">Python-urllib/2.7</code> is used, let’s also include it in our search.</p><ul><li><code class="language-plaintext highlighter-rouge">index="botsv1" sourcetype="stream:http" http_method="POST" dest="192.168.250.70" NOT "Acunetix" http_user_agent="Python*"</code></li></ul><div class="row imager__plugin"><img class="img-fluid mx-auto d-block" src="/assets/images/posts/botsv1/21.png" title="botsv1/21.png" alt="botsv1/21.png"></div><p>Scroll down a little bit, we can see that the <code class="language-plaintext highlighter-rouge">form_data</code> contains values of <strong>username</strong> and <strong>password</strong>!</p><p>Considering the below query:</p><ul><li><code class="language-plaintext highlighter-rouge">index="botsv1" sourcetype="stream:http" http_method="POST" dest="192.168.250.70" NOT "Acunetix" http_user_agent="Python*" | table _time,form_data,c_ip | sort + _time</code></li></ul><div class="row imager__plugin"><img class="img-fluid mx-auto d-block" src="/assets/images/posts/botsv1/22.png" title="botsv1/22.png" alt="botsv1/22.png"></div><p>It’s undoubtable that the APT performed password bruteforcing. If we are interested in checking whether the attack is successful, the <code class="language-plaintext highlighter-rouge">User Agent</code> can tell us.</p><ul><li><code class="language-plaintext highlighter-rouge">index="botsv1" sourcetype="stream:http" http_method="POST" dest="192.168.250.70" NOT "Acunetix" | search form_data="*user*pass*" http_user_agent="Mozilla*" | table _time,form_data,http_user_agent,c_ip | sort + _time</code></li></ul><div class="row imager__plugin"><img class="img-fluid mx-auto d-block" src="/assets/images/posts/botsv1/23.png" title="botsv1/23.png" alt="botsv1/23.png"></div><p>It’s very likely that <code class="language-plaintext highlighter-rouge">batman</code> is the correct password. The search revealed that attackers used <code class="language-plaintext highlighter-rouge">Python</code> to bruteforce password then logged in with their actual web browser.</p><p>Finally, if we want to see the timeframe of the two successful logins, we can do so as belows:</p><ul><li><code class="language-plaintext highlighter-rouge">index="botsv1" sourcetype="stream:http" http_method="POST" dest="192.168.250.70" NOT "Acunetix" | search form_data="*passwd=batman*" | table _time,form_data,http_user_agent,c_ip | sort + _time</code></li></ul><div class="row imager__plugin"><img class="img-fluid mx-auto d-block" src="/assets/images/posts/botsv1/24.png" title="botsv1/24.png" alt="botsv1/24.png"></div><p>The meaningful timeframe can also explain a successful bruteforce attack.</p><p><br></p><h2 id="step-5---installation-activities"><strong>Step 5 - Installation Activities</strong></h2><p>As far as the exploitation is successful, we are mostly interested in the malware being transferred to the victim.</p><p>To upload the malware, we want to look at <code class="language-plaintext highlighter-rouge">POST</code> request with the extension of a Windows executable.</p><ul><li><code class="language-plaintext highlighter-rouge">index=botsv1 NOT "Acunetix" sourcetype=stream:http http_method=POST dest=192.168.250.70 ".exe"</code></li></ul><p><strong>part_filename{}</strong> is the field we want to look at, but it’s not enabled by default. We will simply click on <code class="language-plaintext highlighter-rouge">All Fields</code>, then choose <strong>part_filename</strong> to activate it.</p><p>By doing so, we can efficiently extract files are uploaded to the server as the following image:</p><div class="row imager__plugin"><img class="img-fluid mx-auto d-block" src="/assets/images/posts/botsv1/25.png" title="botsv1/25.png" alt="botsv1/25.png"></div><p>The file <code class="language-plaintext highlighter-rouge">3791.exe</code> is malicious due to the source address.</p><p><code class="language-plaintext highlighter-rouge">Splunk</code> provides the ability to extract hashes of the uploaded files. To do that, we focus on <code class="language-plaintext highlighter-rouge">Sysmon</code> log events:</p><ul><li><code class="language-plaintext highlighter-rouge">index=botsv1 sourcetype="XmlWinEventLog:Microsoft-Windows-Sysmon/Operational"</code></li></ul><p>We can narrow down the search by looking at the executable <code class="language-plaintext highlighter-rouge">3791.exe</code> and <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/sysmon">Event ID</a> is 1.</p><ul><li><code class="language-plaintext highlighter-rouge">index=botsv1 3791.exe sourcetype="XmlWinEventLog:Microsoft-Windows-Sysmon/Operational" EventCode=1</code></li></ul><div class="row imager__plugin"><img class="img-fluid mx-auto d-block" src="/assets/images/posts/botsv1/26.png" title="botsv1/26.png" alt="botsv1/26.png"></div><p>We can make an additional step by adding <code class="language-plaintext highlighter-rouge">CommandLine</code> to only filter the commands initiated from <code class="language-plaintext highlighter-rouge">3791.exe</code>.</p><ul><li><code class="language-plaintext highlighter-rouge">index=botsv1 "3791.exe" sourcetype="XmlWinEventLog:Microsoft-Windows-Sysmon/Operational" EventCode=1 CommandLine=3791.exe</code></li></ul><div class="row imager__plugin"><img class="img-fluid mx-auto d-block" src="/assets/images/posts/botsv1/27.png" title="botsv1/27.png" alt="botsv1/27.png"></div><p>In order to extract the relevant hash, we can do as follows:</p><ul><li><code class="language-plaintext highlighter-rouge">index=botsv1 "3791.exe" sourcetype="XmlWinEventLog:Microsoft-Windows-Sysmon/Operational" EventCode=1 CommandLine=3791.exe | stats values(md5)</code></li></ul><div class="row imager__plugin"><img class="img-fluid mx-auto d-block" src="/assets/images/posts/botsv1/28.png" title="botsv1/28.png" alt="botsv1/28.png"></div><p>We then submit the hash onto <a href="www.hybrid-analysis.com">www.hybrid-analysis.com</a>, it’s marked as malicious.</p><p><br></p><h2 id="step-6---command-and-control-server"><strong>Step 6 - Command and Control Server</strong></h2><p>In this phase, the APT will mostly interact with the victim over C2. It’s very likely that C2 will use domain to interact with the victim.</p><p><code class="language-plaintext highlighter-rouge">Splunk</code> allows us to extract domains with <code class="language-plaintext highlighter-rouge">stream:dns</code> sourcetype. Let’s us filter DNS traffic of the <code class="language-plaintext highlighter-rouge">22.23.63.114</code> ip address.</p><ul><li><code class="language-plaintext highlighter-rouge">index=botsv1 sourcetype=stream:dns "23.22.63.114" | stats values(name{})</code></li></ul><div class="row imager__plugin"><img class="img-fluid mx-auto d-block" src="/assets/images/posts/botsv1/29.png" title="botsv1/29.png" alt="botsv1/29.png"></div><p>If we look a bit closer, this domain defaces our webserver.</p><ul><li><code class="language-plaintext highlighter-rouge">index=botsv1 sourcetype="stream:http" "prankglassinebracket.jumpingcrab.com"</code></li></ul><div class="row imager__plugin"><img class="img-fluid mx-auto d-block" src="/assets/images/posts/botsv1/30.png" title="botsv1/30.png" alt="botsv1/30.png"></div><center><script src="https://tryhackme.com/badge/44696"></script></center></div></div><div class="p-0 p-lg-3 mb-4 layout_post__footer"></div></div></div></div></div><div class="py-1 position-fixed fixed-bottom w-100 footer"><div class="container-fluid"><div class="row"><div class="text-center col-12 col-md-4"><span class="footer__copyright">Infomation Security © 2021-2023 • All right reserved.</span></div><div class="text-center col-12 col-md-4 d-none d-md-block"><span class="footer__message">Simplicity is fashionable.</span></div><div class="text-center col-12 col-md-4"><span class="footer__madeby">Made with&nbsp;<a href="https://jekyllrb.com" target="_blank">Jekyll</a>&nbsp;using&nbsp;<a href="https://github.com/williamcanin/typing-jekyll-template" target="_blank">Typing</a>&nbsp;Theme.</span></div></div></div></div><div class="d-block d-lg-none position-fixed fixed-bottom w-100 scrolltop"><div class="float-right mr-3 scrolltop__wrapper"><a class="mr-3 scrolltop__button" href="#top"><i class="fas fa-caret-up"></i></a></div></div><script type="text/javascript" src="https://jayngng.github.io/assets/vendor/js/jquery.min.js"></script><script type="text/javascript" src="https://jayngng.github.io/assets/vendor/js/popper.min.js"></script><script type="text/javascript" src="https://jayngng.github.io/assets/vendor/js/bootstrap.min.js"></script><script type="text/javascript" src="https://jayngng.github.io/assets/vendor/js/simple-jekyll-search.min.js"></script><script type="text/javascript" src="https://jayngng.github.io/assets/js/global.js"></script><script type="text/javascript" src="https://jayngng.github.io/assets/js/post.js"></script><script src="https://jayngng.github.io/assets/vendor/jektify/js/jektify.min.js"></script></body><script id="dsq-count-scr" src="https://.disqus.com/count.js" async></script></html>