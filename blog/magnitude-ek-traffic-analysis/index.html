<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Magnitude EK - Traffic Analysis | Infomation Security - Blog</title><meta name="description" content="Description  You have a pcap, and you need to figure out what’s going on.  What’s happening here?  Download the .pcap here.(The password is: infected).
    "><meta http-equiv="cache-control" content="max-age=29030400"><meta http-equiv="pragma" content="public"><meta name="keywords" content=""><meta name="author" content="Jay Nguyen"><meta http-equiv="Content-Language" content="en"><meta property="og:locale" content="en"><meta property="og:site_name" content="Infomation Security"><meta property="og:type" content="WebSite"><meta property="og:url" content="https://jayngng.github.io/blog/magnitude-ek-traffic-analysis/"><meta property="og:description" content="
    Blog"><meta property="og:title" content="Magnitude EK - Traffic Analysis
  "><link rel="canonical" href="https://jayngng.github.io/blog/magnitude-ek-traffic-analysis/"><link type="application/atom+xml" rel="alternate" title="Infomation Security" href="https://jayngng.github.io/feed.xml"><link rel="icon" type="image/png" sizes="32x32" href="https://jayngng.github.io/assets/images/favicon/favicon-32x32.png"><link href="https://fonts.googleapis.com/css?family=Special+Elite" rel="stylesheet"><script defer="defer" src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script><link rel="stylesheet" href="https://jayngng.github.io/assets/css/bootstrap.css"><link rel="stylesheet" href="https://jayngng.github.io/assets/css/jektify.css"><link rel="stylesheet" href="https://jayngng.github.io/assets/css/whiteglass.css"></head><body class="body underline_links" id="top"><div class="container layout_default"><div class="row"><div class="col-lg-3 px-0 mt-0 sidebar"><div class="py-3 sticky-top flex-grow-1"><div class="pt-3 sidebar__wrapper"><div class="nav flex-lg-column mx-3 mx-lg-0"><div class="d-none d-sm-block sidebar__avatar_flip"><div class="sidebar__avatar_flip-card"><a class="sidebar__avatar_flip-front sidebar__avatar_flip-face" href="https://jayngng.github.io/"><img class="p-1 img-fluid mx-auto d-block animation__pulse sidebar_avatar_circle sidebar_avatar_background sidebar_avatar_border image_avatar" src="/assets/images/avatar/author.jpg" alt="Avatar"> </a><a class="sidebar__avatar_flip-back sidebar__avatar_flip-face" href="https://jayngng.github.io/"><img class="p-1 img-fluid mx-auto d-block animation__pulse sidebar_avatar_circle sidebar_avatar_background sidebar_avatar_border image_avatar" src="/assets/images/avatar/athor_m.png" alt="Avatar"></a></div></div><h1 class="p-2 text-center d-md-flex align-items-center mx-auto animation__sidebar-title sidebar__title"><a href="https://jayngng.github.io/" class="nav-link" style="font-size: 2.3rem">whoami</a></h1><div class="p-2 mx-3 d-md-flex flex-md-column align-items-md-start align-items-center align-items-lg-start flex-lg-column mx-auto mr-lg-3 ml-lg-3 sidebar__menu animation__sidebar-menu"><div class="my-1 d-none d-md-block mr-3 sidebar__menu-title">Menu: Blog</div><li class="mr-3 mr-lg-0 float-left float-lg-none sidebar__menu-item"><i class="mr-1 fas fa-edit"></i> <a class="sidebar__menu-link" href="https://jayngng.github.io/blog/">Blog</a></li><li class="mr-3 mr-lg-0 float-left float-lg-none sidebar__menu-item"><i class="mr-1 fas fa-tags"></i> <a class="sidebar__menu-link" href="https://jayngng.github.io/blog/tags/">Tags</a></li><li class="mr-3 mr-lg-0 float-left float-lg-none sidebar__menu-item"><i class="mr-1 fas fa-search"></i> <a class="sidebar__menu-link" href="https://jayngng.github.io/blog/search/">Search</a></li></div></div></div></div></div><div class="col-lg-9 p-0 py-4 content" id="main"><div class="px-3 mt-lg-0 layout_post animation__content" itemscope itemtype="http://schema.org/BlogPosting"><div class="p-0 p-lg-3 mb-4 layout_post__header"><h1 class="font-weight-bold layout_post__title">Magnitude EK - Traffic Analysis</h1><div class="layout_post__date"><time class="layout_post__time"><i class="far fa-calendar-alt"></i> September 19, 2021</time></div><div class="layout_post__tags"><i class="fa fa-tags"></i>&nbsp;Tags:&nbsp; | <a class="layout_post__tags-link" href="https://jayngng.github.io/blog/tags//snort">snort</a> | <a class="layout_post__tags-link" href="https://jayngng.github.io/blog/tags//traffic_analysis">traffic_analysis</a> | <a class="layout_post__tags-link" href="https://jayngng.github.io/blog/tags//ek">ek</a> |</div><div class="layout_post__reading_time"><i class="far fa-clock"></i> Read this in "about 6 minutes".</div></div><div class="p-0 p-lg-3 mb-4 layout_post__content"><div class="d-block"><div class="py-3 row"><div class="offset-6 col-6 offset-sm-9 col-sm-3 offset-lg-10 col-lg-2"></div></div><h2 id="description"><strong>Description</strong></h2><ul><li>You have a pcap, and you need to figure out what’s going on. What’s happening here?</li><li>Download the <code class="language-plaintext highlighter-rouge">.pcap</code> <a href="https://www.malware-traffic-analysis.net/2015/05/08/2015-05-08-traffic-analysis-exercise.pcap.zip">here.</a> (The password is: <code class="language-plaintext highlighter-rouge">infected</code>).</li></ul><p><strong>Credit:</strong> malware-traffic-analysis.net</p><p><br></p><h2 id="traffic-overview"><strong>Traffic Overview</strong></h2><p><strong>Tools used:</strong></p><ul><li><code class="language-plaintext highlighter-rouge">Wireshark</code></li><li><code class="language-plaintext highlighter-rouge">Squert</code></li><li><code class="language-plaintext highlighter-rouge">snort</code></li><li><code class="language-plaintext highlighter-rouge">tcpreplay</code></li></ul><h4 id="protocol-hierarchy"><strong>Protocol Hierarchy</strong></h4><p>Most of the traffic are generated by the <code class="language-plaintext highlighter-rouge">HTTP</code> protocol.</p><div class="row imager__plugin"><img class="img-fluid mx-auto d-block" src="/assets/images/posts/magnitude_ek/protocol_hierarchy.png" title="magnitude_ek/protocol_hierarchy.png" alt="magnitude_ek/protocol_hierarchy.png"></div><p>That said, <code class="language-plaintext highlighter-rouge">HTTP</code> is our target of investigation.</p><h4 id="ip-addresses"><strong>IP Addresses</strong></h4><p><code class="language-plaintext highlighter-rouge">Wireshark</code> allows us to summarize the IP addresses engaged in the traffic.</p><p>This can be done by navigating to: <strong><em>Statistics -&gt; IPv4 Statistics -&gt; All Addresses</em></strong></p><div class="row imager__plugin"><img class="img-fluid mx-auto d-block" src="/assets/images/posts/magnitude_ek/ipv4_addresses.png" title="magnitude_ek/ipv4_addresses.png" alt="magnitude_ek/ipv4_addresses.png"></div><p>From the results, we notice two interesting IP addresses:</p><ul><li><code class="language-plaintext highlighter-rouge">192.168.138.158</code> ~ 100%.</li><li><code class="language-plaintext highlighter-rouge">62.75.195.236</code> ~ 64%.</li></ul><p>We’ll drop our attention toward those IP addresses during the analyses.</p><p><br></p><h2 id="traffic-analysis"><strong>Traffic Analysis</strong></h2><p>Let’s first have a look at the web-based traffic. From the <code class="language-plaintext highlighter-rouge">Wireshark</code> filter, enter the following query:</p><ul><li><code class="language-plaintext highlighter-rouge">(http.request or ssl.handshake.type == 1) and !(ssdp)</code></li></ul><div class="row imager__plugin"><img class="img-fluid mx-auto d-block" src="/assets/images/posts/magnitude_ek/web_traffic.png" title="magnitude_ek/web_traffic.png" alt="magnitude_ek/web_traffic.png"></div><p>The query will only render <code class="language-plaintext highlighter-rouge">HTTP</code> or <code class="language-plaintext highlighter-rouge">HTTPS</code> traffic.</p><p>Within the result, we select the first packet and <code class="language-plaintext highlighter-rouge">Follow TCP Stream</code>.</p><p>Now, by inspecting <code class="language-plaintext highlighter-rouge">stream 0</code>, we notice a few suspicious-looking domains.</p><div class="row imager__plugin"><img class="img-fluid mx-auto d-block" src="/assets/images/posts/magnitude_ek/stream0.png" title="magnitude_ek/stream0.png" alt="magnitude_ek/stream0.png"></div><p>Continuing the analysis towards <code class="language-plaintext highlighter-rouge">stream 1</code>, there are two points catching our attention:</p><ol><li>All the <code class="language-plaintext highlighter-rouge">HTTP</code> traffic on <code class="language-plaintext highlighter-rouge">port 80</code> is <strong>encrypted</strong>/<strong>binary</strong>.</li><li><code class="language-plaintext highlighter-rouge">Content-Type</code> is <code class="language-plaintext highlighter-rouge">application/x-shockwave-flash</code>.</li></ol><div class="row imager__plugin"><img class="img-fluid mx-auto d-block" src="/assets/images/posts/magnitude_ek/stream1.png" title="magnitude_ek/stream1.png" alt="magnitude_ek/stream1.png"></div><p>It seems like the victim is downloading an <code class="language-plaintext highlighter-rouge">Adobe Flash</code> application/exploit.</p><p>Upcoming communications are also <strong>encrypted</strong>/<strong>binary</strong>. Therefore, we will analyze the <code class="language-plaintext highlighter-rouge">.pcap</code> with <code class="language-plaintext highlighter-rouge">Snort</code>/<code class="language-plaintext highlighter-rouge">VirusTotal</code> in the next sections.</p><h3 id="magnitude-ek"><strong>Magnitude EK</strong></h3><h4 id="snort"><strong>Snort</strong></h4><p>Let’s us employ <code class="language-plaintext highlighter-rouge">snort</code> to investigate the <code class="language-plaintext highlighter-rouge">.pcap</code> with the following tags:</p><ul><li><code class="language-plaintext highlighter-rouge">-q</code> : for quiet.</li><li><code class="language-plaintext highlighter-rouge">-A console</code> : for output to terminal.</li><li><code class="language-plaintext highlighter-rouge">-c</code> : for a config file.</li><li><code class="language-plaintext highlighter-rouge">-r</code> : to read the <code class="language-plaintext highlighter-rouge">.pcap</code>.</li><li><code class="language-plaintext highlighter-rouge">--daq pcap</code> : to select packet acquisition module.</li></ul><p><strong>The command is as below:</strong></p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>snort <span class="nt">--daq</span> pcap <span class="nt">-A</span> console <span class="nt">-q</span> <span class="nt">-c</span> /etc/nsm/securityonion-eth0/snort.conf <span class="nt">-r</span> traffic.pcap
</code></pre></div></div><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>05/07-20:51:37.788434  <span class="o">[</span><span class="k">**</span><span class="o">]</span> <span class="o">[</span>1:2014726:98] ET POLICY Outdated Flash Version M1 <span class="o">[</span><span class="k">**</span><span class="o">]</span> <span class="o">[</span>Classification: Potential Corporate Privacy Violation] <span class="o">[</span>Priority: 1] <span class="o">{</span>TCP<span class="o">}</span> 192.168.138.158:49185 -&gt; 62.75.195.236:80
05/07-20:51:37.788434  <span class="o">[</span><span class="k">**</span><span class="o">]</span> <span class="o">[</span>1:2020895:5] ET CURRENT_EVENTS Magnitude Flash Exploit <span class="o">(</span>IE<span class="o">)</span> M2 <span class="o">[</span><span class="k">**</span><span class="o">]</span> <span class="o">[</span>Classification: A Network Trojan was detected] <span class="o">[</span>Priority: 1] <span class="o">{</span>TCP<span class="o">}</span> 192.168.138.158:49185 -&gt; 62.75.195.236:80
05/07-20:51:39.132903  <span class="o">[</span><span class="k">**</span><span class="o">]</span> <span class="o">[</span>1:2021054:1] ET CURRENT_EVENTS Magnitude EK Flash Payload ShellCode Apr 23 2015 <span class="o">[</span><span class="k">**</span><span class="o">]</span> <span class="o">[</span>Classification: A Network Trojan was detected] <span class="o">[</span>Priority: 1] <span class="o">{</span>TCP<span class="o">}</span> 62.75.195.236:80 -&gt; 192.168.138.158:49188
05/07-20:51:39.272670  <span class="o">[</span><span class="k">**</span><span class="o">]</span> <span class="o">[</span>1:2017694:4] ET CURRENT_EVENTS Possible Magnitude IE EK Payload Nov 8 2013 <span class="o">[</span><span class="k">**</span><span class="o">]</span> <span class="o">[</span>Classification: A Network Trojan was detected] <span class="o">[</span>Priority: 1] <span class="o">{</span>TCP<span class="o">}</span> 192.168.138.158:49189 -&gt; 62.75.195.236:80
05/07-20:51:39.414407  <span class="o">[</span><span class="k">**</span><span class="o">]</span> <span class="o">[</span>1:2000419:18] ET POLICY PE EXE or DLL Windows file download <span class="o">[</span><span class="k">**</span><span class="o">]</span> <span class="o">[</span>Classification: Potential Corporate Privacy Violation] <span class="o">[</span>Priority: 1] <span class="o">{</span>TCP<span class="o">}</span> 62.75.195.236:80 -&gt; 192.168.138.158:49189
05/07-20:51:39.414407  <span class="o">[</span><span class="k">**</span><span class="o">]</span> <span class="o">[</span>1:2021076:1] ET INFO SUSPICIOUS Dotted Quad Host MZ Response <span class="o">[</span><span class="k">**</span><span class="o">]</span> <span class="o">[</span>Classification: Potentially Bad Traffic] <span class="o">[</span>Priority: 2] <span class="o">{</span>TCP<span class="o">}</span> 62.75.195.236:80 -&gt; 192.168.138.158:49189
05/07-20:51:39.414407  <span class="o">[</span><span class="k">**</span><span class="o">]</span> <span class="o">[</span>1:2009897:7] ET MALWARE Possible Windows executable sent when remote host claims to send html content <span class="o">[</span><span class="k">**</span><span class="o">]</span> <span class="o">[</span>Classification: A Network Trojan was detected] <span class="o">[</span>Priority: 1] <span class="o">{</span>TCP<span class="o">}</span> 62.75.195.236:80 -&gt; 192.168.138.158:49189
05/07-20:51:41.438424  <span class="o">[</span><span class="k">**</span><span class="o">]</span> <span class="o">[</span>1:2017694:4] ET CURRENT_EVENTS Possible Magnitude IE EK Payload Nov 8 2013 <span class="o">[</span><span class="k">**</span><span class="o">]</span> <span class="o">[</span>Classification: A Network Trojan was detected] <span class="o">[</span>Priority: 1] <span class="o">{</span>TCP<span class="o">}</span> 192.168.138.158:49190 -&gt; 62.75.195.236:80
05/07-20:51:41.749079  <span class="o">[</span><span class="k">**</span><span class="o">]</span> <span class="o">[</span>1:2017694:4] ET CURRENT_EVENTS Possible Magnitude IE EK Payload Nov 8 2013 <span class="o">[</span><span class="k">**</span><span class="o">]</span> <span class="o">[</span>Classification: A Network Trojan was detected] <span class="o">[</span>Priority: 1] <span class="o">{</span>TCP<span class="o">}</span> 192.168.138.158:49191 -&gt; 62.75.195.236:80
05/07-20:51:42.059997  <span class="o">[</span><span class="k">**</span><span class="o">]</span> <span class="o">[</span>1:2017694:4] ET CURRENT_EVENTS Possible Magnitude IE EK Payload Nov 8 2013 <span class="o">[</span><span class="k">**</span><span class="o">]</span> <span class="o">[</span>Classification: A Network Trojan was detected] <span class="o">[</span>Priority: 1] <span class="o">{</span>TCP<span class="o">}</span> 192.168.138.158:49192 -&gt; 62.75.195.236:80
05/07-20:51:42.593075  <span class="o">[</span><span class="k">**</span><span class="o">]</span> <span class="o">[</span>1:2017694:4] ET CURRENT_EVENTS Possible Magnitude IE EK Payload Nov 8 2013 <span class="o">[</span><span class="k">**</span><span class="o">]</span> <span class="o">[</span>Classification: A Network Trojan was detected] <span class="o">[</span>Priority: 1] <span class="o">{</span>TCP<span class="o">}</span> 192.168.138.158:49193 -&gt; 62.75.195.236:80
05/07-20:51:42.894386  <span class="o">[</span><span class="k">**</span><span class="o">]</span> <span class="o">[</span>1:2017694:4] ET CURRENT_EVENTS Possible Magnitude IE EK Payload Nov 8 2013 <span class="o">[</span><span class="k">**</span><span class="o">]</span> <span class="o">[</span>Classification: A Network Trojan was detected] <span class="o">[</span>Priority: 1] <span class="o">{</span>TCP<span class="o">}</span> 192.168.138.158:49194 -&gt; 62.75.195.236:80
</code></pre></div></div><p>The outputs indicates that the traffic triggers multiple <code class="language-plaintext highlighter-rouge">snort</code> rules related to <code class="language-plaintext highlighter-rouge">Magnitude EK</code>.</p><p>Same results for <code class="language-plaintext highlighter-rouge">Squert</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>tcpreplay <span class="nt">-t</span> <span class="nt">-i</span> eth0 traffic.pcap
sending out eth0 
processing file: traffic.pcap
Actual: 761 packets <span class="o">(</span>495665 bytes<span class="o">)</span> sent <span class="k">in </span>0.03 seconds.                Rated: 16522167.0 bps, 126.05 Mbps, 25366.67 pps
Statistics <span class="k">for </span>network device: eth0
        Attempted packets:         761
        Successful packets:        761
        Failed packets:            0
        Retried packets <span class="o">(</span>ENOBUFS<span class="o">)</span>: 0
        Retried packets <span class="o">(</span>EAGAIN<span class="o">)</span>:  0
</code></pre></div></div><div class="row imager__plugin"><img class="img-fluid mx-auto d-block" src="/assets/images/posts/magnitude_ek/squert.png" title="magnitude_ek/squert.png" alt="magnitude_ek/squert.png"></div><h4 id="virustotal"><strong>VirusTotal</strong></h4><p>Now, we extract the malware and submit it onto <strong>Virus Total</strong>.</p><p>To extract the malware, from <code class="language-plaintext highlighter-rouge">Wireshark</code>, we navigate to:</p><ul><li><strong><em>File -&gt; Export Objects -&gt; HTTP</em></strong></li></ul><div class="row imager__plugin"><img class="img-fluid mx-auto d-block" src="/assets/images/posts/magnitude_ek/malware_extract.png" title="magnitude_ek/malware_extract.png" alt="magnitude_ek/malware_extract.png"></div><p>Save the <strong>packet #426</strong> due to the large size.</p><p>Let’s us then pass it to <strong>Virus Total</strong>.</p><div class="row imager__plugin"><img class="img-fluid mx-auto d-block" src="/assets/images/posts/magnitude_ek/virustotal.png" title="magnitude_ek/virustotal.png" alt="magnitude_ek/virustotal.png"></div><p>The <code class="language-plaintext highlighter-rouge">malware</code> is lighting up as a Christmas tree!.</p><p>Analyzing <strong>packet #426</strong>, it’s also a <strong>MS Windows executable</strong> regardless of the <code class="language-plaintext highlighter-rouge">Content-Type</code> is <code class="language-plaintext highlighter-rouge">html</code>.</p><div class="row imager__plugin"><img class="img-fluid mx-auto d-block" src="/assets/images/posts/magnitude_ek/packet426.png" title="magnitude_ek/packet426.png" alt="magnitude_ek/packet426.png"></div><p><br></p><h2 id="conclusion"><strong>Conclusion</strong></h2><p>From the analyses, we can safely conclude that the user is infected by <code class="language-plaintext highlighter-rouge">Magnitude EK</code>, which exploits the vulnerable <strong>Adobe Flash</strong> and installs ransomeware on the contaminated system.</p><center><script src="https://tryhackme.com/badge/44696"></script></center></div></div><div class="p-0 p-lg-3 mb-4 layout_post__footer"></div></div></div></div></div><div class="py-1 position-fixed fixed-bottom w-100 footer"><div class="container-fluid"><div class="row"><div class="text-center col-12 col-md-4"><span class="footer__copyright">Infomation Security © 2021-2021 • All right reserved.</span></div><div class="text-center col-12 col-md-4 d-none d-md-block"><span class="footer__message">Simplicity is fashionable.</span></div><div class="text-center col-12 col-md-4"><span class="footer__madeby">Made with&nbsp;<a href="https://jekyllrb.com" target="_blank">Jekyll</a>&nbsp;using&nbsp;<a href="https://github.com/williamcanin/typing-jekyll-template" target="_blank">Typing</a>&nbsp;Theme.</span></div></div></div></div><div class="d-block d-lg-none position-fixed fixed-bottom w-100 scrolltop"><div class="float-right mr-3 scrolltop__wrapper"><a class="mr-3 scrolltop__button" href="#top"><i class="fas fa-caret-up"></i></a></div></div><script type="text/javascript" src="https://jayngng.github.io/assets/vendor/js/jquery.min.js"></script><script type="text/javascript" src="https://jayngng.github.io/assets/vendor/js/popper.min.js"></script><script type="text/javascript" src="https://jayngng.github.io/assets/vendor/js/bootstrap.min.js"></script><script type="text/javascript" src="https://jayngng.github.io/assets/vendor/js/simple-jekyll-search.min.js"></script><script type="text/javascript" src="https://jayngng.github.io/assets/js/global.js"></script><script type="text/javascript" src="https://jayngng.github.io/assets/js/post.js"></script><script src="https://jayngng.github.io/assets/vendor/jektify/js/jektify.min.js"></script></body><script id="dsq-count-scr" src="https://.disqus.com/count.js" async></script></html>